!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).optimizelyReactSdk={},e.React)}(this,function(e,E){"use strict";var g=E.createContext({optimizely:null,isServerSide:!1,timeout:0}),i=g.Consumer,n=g.Provider,o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function r(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var _=function(){return(_=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};var p="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports}for(var d=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=(n.prototype.handleError=function(e){},n);function n(){}var i=new(t.NoopErrorHandler=r);t.setErrorHandler=function(e){i=e},t.getErrorHandler=function(){return i},t.resetErrorHandler=function(){i=new r}}),h=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),(t=t.LogLevel||(t.LogLevel={}))[t.NOTSET=0]="NOTSET",t[t.DEBUG=1]="DEBUG",t[t.INFO=2]="INFO",t[t.WARNING=3]="WARNING",t[t.ERROR=4]="ERROR"}),c=t(function(e){var t,r,n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);n?(t=new Uint8Array(16),e.exports=function(){return n(t),t}):(r=new Array(16),e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),r[t]=e>>>((3&t)<<3)&255;return r})}),s=[],a=0;a<256;++a)s[a]=(a+256).toString(16).substr(1);var f,v,I=function(e,t){return t=t||0,[s[e[t++]],s[e[t++]],s[e[t++]],s[e[t++]],"-",s[e[t++]],s[e[t++]],"-",s[e[t++]],s[e[t++]],"-",s[e[t++]],s[e[t++]],"-",s[e[t++]],s[e[t++]],s[e[t++]],s[e[t++]],s[e[t++]],s[e[t++]]].join("")},y=0,O=0;var u=function(e,t,r){var n=t&&r||0,i=t||[],o=(e=e||{}).node||f,s=void 0!==e.clockseq?e.clockseq:v;null!=o&&null!=s||(u=c(),null==o&&(o=f=[1|u[0],u[1],u[2],u[3],u[4],u[5]]),null==s&&(s=v=16383&(u[6]<<8|u[7])));var a=void 0!==e.msecs?e.msecs:(new Date).getTime(),r=void 0!==e.nsecs?e.nsecs:O+1,u=a-y+(r-O)/1e4;if(u<0&&void 0===e.clockseq&&(s=s+1&16383),(u<0||y<a)&&void 0===e.nsecs&&(r=0),1e4<=r)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");y=a,v=s,r=(1e4*(268435455&(a+=122192928e5))+(O=r))%4294967296,i[n++]=r>>>24&255,i[n++]=r>>>16&255,i[n++]=r>>>8&255,i[n++]=255&r,a=a/4294967296*1e4&268435455,i[n++]=a>>>8&255,i[n++]=255&a,i[n++]=a>>>24&15|16,i[n++]=a>>>16&255,i[n++]=s>>>8|128,i[n++]=255&s;for(var l=0;l<6;++l)i[n+l]=o[l];return t||I(i)};var l=function(e,t,r){var n=t&&r||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var i=(e=e||{}).random||(e.rng||c)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var o=0;o<16;++o)t[n+o]=i[o];return t||I(i)},R=l;R.v1=u,R.v4=l;var T=R,N=t(function(e,t){function i(t){return Object.keys(t).map(function(e){return t[e]})}Object.defineProperty(t,"__esModule",{value:!0}),t.getTimestamp=function(){return(new Date).getTime()},t.generateUUID=function(){return T.v4()},t.isValidEnum=function(e,t){for(var r=!1,n=Object.keys(e),i=0;i<n.length;i++)if(t===e[n[i]]){r=!0;break}return r},t.groupBy=function(e,r){var n={};return e.forEach(function(e){var t=r(e);n[t]=n[t]||[],n[t].push(e)}),i(n)},t.objectValues=i,t.find=function(e,t){for(var r,n=0,i=e;n<i.length;n++){var o=i[n];if(t(o)){r=o;break}}return r},t.keyBy=function(e,r){var n={};return e.forEach(function(e){var t=r(e);n[t]=e}),n},t.sprintf=function(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];var n=0;return e.replace(/%s/g,function(){var e=r[n++],t=typeof e;return"function"==t?e():"string"==t?e:String(e)})}}),m=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r={NOTSET:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4};function n(e){return"string"!=typeof e?e:("WARN"===(e=e.toUpperCase())&&(e="WARNING"),r[e]?r[e]:e)}var i=(o.prototype.getLogger=function(e){return e?(this.loggers[e]||(this.loggers[e]=new c({messagePrefix:e})),this.loggers[e]):this.defaultLoggerFacade},o);function o(){this.defaultLoggerFacade=new c,this.loggers={}}var s=(a.prototype.log=function(e,t){this.shouldLog(e)&&this.logToConsole&&(t=this.prefix+" - "+this.getLogLevelName(e)+" "+this.getTime()+" "+t,this.consoleLog(e,[t]))},a.prototype.setLogLevel=function(e){e=n(e),N.isValidEnum(h.LogLevel,e)&&void 0!==e?this.logLevel=e:this.logLevel=h.LogLevel.ERROR},a.prototype.getTime=function(){return(new Date).toISOString()},a.prototype.shouldLog=function(e){return e>=this.logLevel},a.prototype.getLogLevelName=function(e){switch(e){case h.LogLevel.DEBUG:return"DEBUG";case h.LogLevel.INFO:return"INFO ";case h.LogLevel.WARNING:return"WARN ";case h.LogLevel.ERROR:return"ERROR";default:return"NOTSET"}},a.prototype.consoleLog=function(e,t){switch(e){case h.LogLevel.DEBUG:console.log.apply(console,t);break;case h.LogLevel.INFO:console.info.apply(console,t);break;case h.LogLevel.WARNING:console.warn.apply(console,t);break;case h.LogLevel.ERROR:console.error.apply(console,t);break;default:console.log.apply(console,t)}},a);function a(e){void 0===e&&(e={}),this.logLevel=h.LogLevel.NOTSET,void 0!==e.logLevel&&N.isValidEnum(h.LogLevel,e.logLevel)&&this.setLogLevel(e.logLevel),this.logToConsole=void 0===e.logToConsole||!!e.logToConsole,this.prefix=void 0!==e.prefix?e.prefix:"[OPTIMIZELY]"}t.ConsoleLogHandler=s;var u=h.LogLevel.NOTSET,l=null,c=(f.prototype.log=function(e,t){this.internalLog(n(e),{message:t,splat:[]})},f.prototype.info=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.namedLog(h.LogLevel.INFO,e,t)},f.prototype.debug=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.namedLog(h.LogLevel.DEBUG,e,t)},f.prototype.warn=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.namedLog(h.LogLevel.WARNING,e,t)},f.prototype.error=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.namedLog(h.LogLevel.ERROR,e,t)},f.prototype.format=function(e){return(this.messagePrefix?this.messagePrefix+": ":"")+N.sprintf.apply(void 0,[e.message].concat(e.splat))},f.prototype.internalLog=function(e,t){l&&(e<u||(l.log(e,this.format(t)),t.error&&t.error instanceof Error&&d.getErrorHandler().handleError(t.error)))},f.prototype.namedLog=function(e,t,r){var n,i;if(t instanceof Error)return t=(n=t).message,void this.internalLog(e,{error:n,message:t,splat:r});0!==r.length?((i=r[r.length-1])instanceof Error&&(n=i,r.splice(-1)),this.internalLog(e,{message:t,error:n,splat:r})):this.internalLog(e,{message:t,splat:r})},f);function f(e){void 0===e&&(e={}),this.messagePrefix="",e.messagePrefix&&(this.messagePrefix=e.messagePrefix)}var p=new i;t.getLogger=function(e){return p.getLogger(e)},t.setLogHandler=function(e){l=e},t.setLogLevel=function(e){e=n(e),u=N.isValidEnum(h.LogLevel,e)&&void 0!==e?e:h.LogLevel.ERROR},t.getLogLevel=function(){return u},t.resetLogger=function(){p=new i,u=h.LogLevel.NOTSET}}),Xe=t(function(e,r){function t(e){for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t])}Object.defineProperty(r,"__esModule",{value:!0}),t(d),t(h),t(m)}),A="function"==typeof Symbol&&Symbol.for,U=A?Symbol.for("react.element"):60103,L=A?Symbol.for("react.portal"):60106,b=A?Symbol.for("react.fragment"):60107,S=A?Symbol.for("react.strict_mode"):60108,D=A?Symbol.for("react.profiler"):60114,V=A?Symbol.for("react.provider"):60109,P=A?Symbol.for("react.context"):60110,C=A?Symbol.for("react.async_mode"):60111,F=A?Symbol.for("react.concurrent_mode"):60111,M=A?Symbol.for("react.forward_ref"):60112,x=A?Symbol.for("react.suspense"):60113,k=A?Symbol.for("react.suspense_list"):60120,w=A?Symbol.for("react.memo"):60115,B=A?Symbol.for("react.lazy"):60116,j=A?Symbol.for("react.block"):60121,G=A?Symbol.for("react.fundamental"):60117,K=A?Symbol.for("react.responder"):60118,Y=A?Symbol.for("react.scope"):60119;function H(e){if("object"==typeof e&&null!==e){var t=e.$$typeof;switch(t){case U:switch(e=e.type){case C:case F:case b:case D:case S:case x:return e;default:switch(e=e&&e.$$typeof){case P:case M:case B:case w:case V:return e;default:return t}}case L:return t}}}function z(e){return H(e)===F}var X={AsyncMode:C,ConcurrentMode:F,ContextConsumer:P,ContextProvider:V,Element:U,ForwardRef:M,Fragment:b,Lazy:B,Memo:w,Portal:L,Profiler:D,StrictMode:S,Suspense:x,isAsyncMode:function(e){return z(e)||H(e)===C},isConcurrentMode:z,isContextConsumer:function(e){return H(e)===P},isContextProvider:function(e){return H(e)===V},isElement:function(e){return"object"==typeof e&&null!==e&&e.$$typeof===U},isForwardRef:function(e){return H(e)===M},isFragment:function(e){return H(e)===b},isLazy:function(e){return H(e)===B},isMemo:function(e){return H(e)===w},isPortal:function(e){return H(e)===L},isProfiler:function(e){return H(e)===D},isStrictMode:function(e){return H(e)===S},isSuspense:function(e){return H(e)===x},isValidElementType:function(e){return"string"==typeof e||"function"==typeof e||e===b||e===F||e===D||e===S||e===x||e===k||"object"==typeof e&&null!==e&&(e.$$typeof===B||e.$$typeof===w||e.$$typeof===V||e.$$typeof===P||e.$$typeof===M||e.$$typeof===G||e.$$typeof===K||e.$$typeof===Y||e.$$typeof===j)},typeOf:H},q=(t(function(e,t){}),t(function(e){e.exports=X})),W={childContextTypes:!0,contextType:!0,contextTypes:!0,defaultProps:!0,displayName:!0,getDefaultProps:!0,getDerivedStateFromError:!0,getDerivedStateFromProps:!0,mixins:!0,propTypes:!0,type:!0},J={name:!0,length:!0,prototype:!0,caller:!0,callee:!0,arguments:!0,arity:!0},Z={$$typeof:!0,compare:!0,defaultProps:!0,displayName:!0,propTypes:!0,type:!0},$={};function Q(e){return q.isMemo(e)?Z:$[e.$$typeof]||W}$[q.ForwardRef]={$$typeof:!0,render:!0,defaultProps:!0,displayName:!0,propTypes:!0},$[q.Memo]=Z;var ee=Object.defineProperty,te=Object.getOwnPropertyNames,re=Object.getOwnPropertySymbols,ne=Object.getOwnPropertyDescriptor,ie=Object.getPrototypeOf,oe=Object.prototype;var se=function e(t,r,n){if("string"!=typeof r){var i;!oe||(i=ie(r))&&i!==oe&&e(t,i,n);var o=te(r);re&&(o=o.concat(re(r)));for(var s=Q(t),a=Q(r),u=0;u<o.length;++u){var l=o[u];if(!(J[l]||n&&n[l]||a&&a[l]||s&&s[l])){var c=ne(r,l);try{ee(t,l,c)}catch(e){}}}}return t};function ae(r,e,t){function n(e,t){return E.createElement(r,_({},e,{forwardedRef:t}))}return n.displayName=t+"("+(e.displayName||e.name)+")",se(E.forwardRef(n),e)}function ue(e){return"object"==typeof e&&null!==e?e:{}}function le(e,t){var r=ue(e),n=ue(t),e=Object.keys(r),t=Object.keys(n);return e.length===t.length&&e.every(function(e){return e in n&&r[e]===n[e]})}var ce,fe=Xe.getLogger("<OptimizelyProvider>"),pe=(r(de,ce=E.Component),de.prototype.componentDidUpdate=function(e){e.isServerSide||(e=this.props.optimizely,this.props.user&&"id"in this.props.user&&(e.user.id&&function(e,t){if(e.id===t.id){var r=Object.keys(e.attributes),n=Object.keys(t.attributes);if(r.sort(),n.sort(),r.length===n.length){for(var i=0;i<r.length;i++){var o=r[i],s=n[i];if(o!==s)return;if(e.attributes[o]!==t.attributes[s])return}return 1}}}({id:e.user.id,attributes:e.user.attributes},{id:this.props.user.id,attributes:this.props.user.attributes||{}})||e.setUser(this.props.user)))},de.prototype.render=function(){var e=this.props,t=e.optimizely,r=e.children,e=e.timeout,e={optimizely:t,isServerSide:!!this.props.isServerSide,timeout:e};return E.createElement(n,{value:e},r)},de);function de(e){var t=ce.call(this,e)||this,r=e.optimizely,n=e.userId,i=e.userAttributes,o=e.user,e=null;return o?"then"in o?o.then(function(e){r.setUser(e)}):e={id:o.id,attributes:o.attributes||{}}:n&&(e={id:n,attributes:i||{}},fe.warn("Passing userId and userAttributes as props is deprecated, please switch to using `user` prop")),e&&r.setUser(e),t}function Ee(e,t,r,n,i){var o="re-evaluating "+t+'="'+r+'" for user="'+e.user.id+'"',s=e.notificationCenter.addNotificationListener(Ve.enums.NOTIFICATION_TYPES.OPTIMIZELY_CONFIG_UPDATE,function(){n.info(Ve.enums.NOTIFICATION_TYPES.OPTIMIZELY_CONFIG_UPDATE+", "+o),i()}),a=e.onUserUpdate(function(){n.info("User update, "+o),i()});return function(){e.notificationCenter.removeNotificationListener(s),a()}}var ge,_e=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.areEventContextsEqual=void 0,t.areEventContextsEqual=function(e,t){return e=e.context,t=t.context,e.accountId===t.accountId&&e.projectId===t.projectId&&e.clientName===t.clientName&&e.clientVersion===t.clientVersion&&e.revision===t.revision&&e.anonymizeIP===t.anonymizeIP&&e.botFiltering===t.botFiltering}}),he=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultEventQueue=t.SingleEventQueue=void 0;var r=Xe.getLogger("EventProcessor"),i=(n.prototype.start=function(){this.timeoutId=setTimeout(this.callback,this.timeout)},n.prototype.refresh=function(){this.stop(),this.start()},n.prototype.stop=function(){this.timeoutId&&clearTimeout(this.timeoutId)},n);function n(e){var t=e.timeout,e=e.callback;this.timeout=Math.max(t,0),this.callback=e}var o=(s.prototype.start=function(){},s.prototype.stop=function(){return Promise.resolve()},s.prototype.enqueue=function(e){this.sink([e])},s);function s(e){e=e.sink;this.sink=e}t.SingleEventQueue=o;a.prototype.start=function(){this.started=!0},a.prototype.stop=function(){this.started=!1;var e=this.sink(this.buffer);return this.buffer=[],this.timer.stop(),e},a.prototype.enqueue=function(e){var t;this.started?((t=this.buffer[0])&&!this.batchComparator(t,e)&&this.flush(),0===this.buffer.length&&this.timer.refresh(),this.buffer.push(e),this.buffer.length>=this.maxQueueSize&&this.flush()):r.warn("Queue is stopped, not accepting event")},a.prototype.flush=function(){this.sink(this.buffer),this.buffer=[],this.timer.stop()},o=a;function a(e){var t=e.flushInterval,r=e.maxQueueSize,n=e.sink,e=e.batchComparator;this.buffer=[],this.maxQueueSize=Math.max(r,1),this.sink=n,this.batchComparator=e,this.timer=new i({callback:this.flush.bind(this),timeout:t}),this.started=!1}t.DefaultEventQueue=o}),qe=t(function(e,t){function i(t){return Object.keys(t).map(function(e){return t[e]})}Object.defineProperty(t,"__esModule",{value:!0}),t.generateUUID=function(){return T.v4()},t.getTimestamp=function(){return(new Date).getTime()},t.isValidEnum=function(e,t){for(var r=!1,n=Object.keys(e),i=0;i<n.length;i++)if(t===e[n[i]]){r=!0;break}return r},t.groupBy=function(e,r){var n={};return e.forEach(function(e){var t=r(e);n[t]=n[t]||[],n[t].push(e)}),i(n)},t.objectValues=i,t.objectEntries=function(t){return Object.keys(t).map(function(e){return[e,t[e]]})},t.find=function(e,t){for(var r,n=0,i=e;n<i.length;n++){var o=i[n];if(t(o)){r=o;break}}return r},t.keyBy=function(e,r){var n={};return e.forEach(function(e){var t=r(e);n[t]=e}),n},t.sprintf=function(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];var n=0;return e.replace(/%s/g,function(){var e=r[n++],t=typeof e;return"function"==t?e():"string"==t?e:String(e)})},(t=t.NOTIFICATION_TYPES||(t.NOTIFICATION_TYPES={})).ACTIVATE="ACTIVATE:experiment, user_id,attributes, variation, event",t.DECISION="DECISION:type, userId, attributes, decisionInfo",t.LOG_EVENT="LOG_EVENT:logEvent",t.OPTIMIZELY_CONFIG_UPDATE="OPTIMIZELY_CONFIG_UPDATE",t.TRACK="TRACK:event_key, user_id, attributes, event_tags, event"}),ve=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sendEventNotification=t.getQueue=t.validateAndGetBatchSize=t.validateAndGetFlushInterval=t.DEFAULT_BATCH_SIZE=t.DEFAULT_FLUSH_INTERVAL=void 0,t.DEFAULT_FLUSH_INTERVAL=3e4,t.DEFAULT_BATCH_SIZE=10;var r=Xe.getLogger("EventProcessor");t.validateAndGetFlushInterval=function(e){return e<=0&&(r.warn("Invalid flushInterval "+e+", defaulting to "+t.DEFAULT_FLUSH_INTERVAL),e=t.DEFAULT_FLUSH_INTERVAL),e},t.validateAndGetBatchSize=function(e){return(e=Math.floor(e))<1&&(r.warn("Invalid batchSize "+e+", defaulting to "+t.DEFAULT_BATCH_SIZE),e=t.DEFAULT_BATCH_SIZE),e=Math.max(1,e)},t.getQueue=function(e,t,r,n){return r=1<e?new he.DefaultEventQueue({flushInterval:t,maxQueueSize:e,sink:r,batchComparator:n}):new he.SingleEventQueue({sink:r})},t.sendEventNotification=function(e,t){e&&e.sendNotifications(qe.NOTIFICATION_TYPES.LOG_EVENT,t)}}),Ie=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}),ye=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}),Oe=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageStore=void 0;var r=Xe.getLogger("EventProcessor"),n=(i.prototype.get=function(e){return this.getMap()[e]||null},i.prototype.set=function(e,t){var r=this.getMap();r[e]=t,this.replace(r)},i.prototype.remove=function(e){var t=this.getMap();delete t[e],this.replace(t)},i.prototype.values=function(){return qe.objectValues(this.getMap())},i.prototype.clear=function(){this.replace({})},i.prototype.replace=function(e){try{window.localStorage&&localStorage.setItem(this.LS_KEY,JSON.stringify(e)),this.clean()}catch(e){r.error(e)}},i.prototype.clean=function(){var t=this.getMap(),e=Object.keys(t),r=e.length-this.maxValues;if(!(r<1)){var n=e.map(function(e){return{key:e,value:t[e]}});n.sort(function(e,t){return e.value.timestamp-t.value.timestamp});for(var i=0;i<r;i++)delete t[n[i].key];this.replace(t)}},i.prototype.getMap=function(){try{var e=window.localStorage&&localStorage.getItem(this.LS_KEY);if(e)return JSON.parse(e)||{}}catch(e){r.error(e)}return{}},i);function i(e){var t=e.key,e=e.maxValues,e=void 0===e?1e3:e;this.LS_KEY=t,this.maxValues=e}t.LocalStorageStore=n}),Re=t(function(e,t){var n,r=p&&p.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStoragePendingEventsDispatcher=t.PendingEventsDispatcher=void 0;var i=Xe.getLogger("EventProcessor"),o=(s.prototype.dispatchEvent=function(e,t){this.send({uuid:qe.generateUUID(),timestamp:qe.getTimestamp(),request:e},t)},s.prototype.sendPendingEvents=function(){var t=this,e=this.store.values();i.debug("Sending %s pending events from previous page",e.length),e.forEach(function(e){try{t.send(e,function(){})}catch(e){}})},s.prototype.send=function(t,r){var n=this;this.store.set(t.uuid,t),this.dispatcher.dispatchEvent(t.request,function(e){n.store.remove(t.uuid),r(e)})},s);function s(e){var t=e.eventDispatcher,e=e.store;this.dispatcher=t,this.store=e}t.PendingEventsDispatcher=o;var a,o=(r(u,a=o),u);function u(e){e=e.eventDispatcher;return a.call(this,{eventDispatcher:e,store:new Oe.LocalStorageStore({maxValues:100,key:"fs_optly_pending_events"})})||this}t.LocalStoragePendingEventsDispatcher=o}),Te=t(function(e,t){var r=p&&p.__assign||function(){return(r=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.formatEvents=t.buildConversionEventV1=t.buildImpressionEventV1=t.makeBatchedEventV1=void 0;var u="campaign_activated",n="custom",i="$opt_bot_filtering";function o(e){var r=[],t=e[0];return e.forEach(function(e){var t;"conversion"!==e.type&&"impression"!==e.type||(t=l(e),"impression"===e.type?t.snapshots.push(a(e)):"conversion"===e.type&&t.snapshots.push(s(e)),r.push(t))}),{client_name:t.context.clientName,client_version:t.context.clientVersion,account_id:t.context.accountId,project_id:t.context.projectId,revision:t.context.revision,anonymize_ip:t.context.anonymizeIP,enrich_decisions:!0,visitors:r}}function s(e){var t=r({},e.tags);delete t.revenue,delete t.value;t={entity_id:e.event.id,key:e.event.key,timestamp:e.timestamp,uuid:e.uuid};return e.tags&&(t.tags=e.tags),null!=e.value&&(t.value=e.value),null!=e.revenue&&(t.revenue=e.revenue),{events:[t]}}function a(e){var t=e.layer,r=e.experiment,n=e.variation,i=e.ruleKey,o=e.flagKey,s=e.ruleType,a=e.enabled,t=t?t.id:null;return{decisions:[{campaign_id:t,experiment_id:r?r.id:null,variation_id:n?n.id:null,metadata:{flag_key:o,rule_key:i,rule_type:s,variation_key:n?n.key:"",enabled:a}}],events:[{entity_id:t,timestamp:e.timestamp,key:u,uuid:e.uuid}]}}function l(e){var t={snapshots:[],visitor_id:e.user.id,attributes:[]};return e.user.attributes.forEach(function(e){t.attributes.push({entity_id:e.entityId,key:e.key,type:"custom",value:e.value})}),"boolean"==typeof e.context.botFiltering&&t.attributes.push({entity_id:i,key:i,type:n,value:e.context.botFiltering}),t}t.makeBatchedEventV1=o,t.buildImpressionEventV1=function(e){var t=l(e);return t.snapshots.push(a(e)),{client_name:e.context.clientName,client_version:e.context.clientVersion,account_id:e.context.accountId,project_id:e.context.projectId,revision:e.context.revision,anonymize_ip:e.context.anonymizeIP,enrich_decisions:!0,visitors:[t]}},t.buildConversionEventV1=function(e){var t=l(e);return t.snapshots.push(s(e)),{client_name:e.context.clientName,client_version:e.context.clientVersion,account_id:e.context.accountId,project_id:e.context.projectId,revision:e.context.revision,anonymize_ip:e.context.anonymizeIP,enrich_decisions:!0,visitors:[t]}},t.formatEvents=function(e){return{url:"https://logx.optimizely.com/v1/events",httpVerb:"POST",params:o(e)}}}),Ne=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=(n.prototype.trackRequest=function(e){var t=this;this.reqsInFlightCount++;function r(){t.reqsInFlightCount--,0===t.reqsInFlightCount&&(t.reqsCompleteResolvers.forEach(function(e){return e()}),t.reqsCompleteResolvers=[])}e.then(r,r)},n.prototype.onRequestsComplete=function(){var t=this;return new Promise(function(e){0===t.reqsInFlightCount?e():t.reqsCompleteResolvers.push(e)})},n);function n(){this.reqsInFlightCount=0,this.reqsCompleteResolvers=[]}t.default=r}),me=t(function(e,t){var r=p&&p.__awaiter||function(e,s,a,u){return new(a=a||Promise)(function(r,t){function n(e){try{o(u.next(e))}catch(e){t(e)}}function i(e){try{o(u.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(n,i)}o((u=u.apply(e,s||[])).next())})},n=p&&p.__generator||function(r,n){var i,o,s,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(r,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},i=p&&p.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LogTierV1EventProcessor=void 0;var o=i(Ne),s=Xe.getLogger("LogTierV1EventProcessor"),i=(a.prototype.drainQueue=function(r){var n=this,e=new Promise(function(e){var t;s.debug("draining queue with %s events",r.length),0!==r.length?(t=Te.formatEvents(r),n.dispatcher.dispatchEvent(t,function(){e()}),ve.sendEventNotification(n.notificationCenter,t)):e()});return this.requestTracker.trackRequest(e),e},a.prototype.process=function(e){this.queue.enqueue(e)},a.prototype.stop=function(){try{return this.queue.stop(),this.requestTracker.onRequestsComplete()}catch(e){s.error('Error stopping EventProcessor: "%s"',e.message,e)}return Promise.resolve()},a.prototype.start=function(){return r(this,void 0,void 0,function(){return n(this,function(e){return this.queue.start(),[2]})})},a);function a(e){var t=e.dispatcher,r=e.flushInterval,n=void 0===r?ve.DEFAULT_FLUSH_INTERVAL:r,r=e.batchSize,r=void 0===r?ve.DEFAULT_BATCH_SIZE:r,e=e.notificationCenter;this.dispatcher=t,this.notificationCenter=e,this.requestTracker=new o.default,n=ve.validateAndGetFlushInterval(n),r=ve.validateAndGetBatchSize(r),this.queue=ve.getQueue(r,n,this.drainQueue.bind(this),_e.areEventContextsEqual)}t.LogTierV1EventProcessor=i}),We=t(function(e,t){var n=p&&p.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),r=p&&p.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),r(_e,t),r(ve,t),r(Ie,t),r(ye,t),r(Re,t),r(Te,t),r(me,t)}),Ae=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_UPDATE_INTERVAL=3e5,t.MIN_UPDATE_INTERVAL=1e3,t.DEFAULT_URL_TEMPLATE="https://cdn.optimizely.com/datafiles/%s.json",t.DEFAULT_AUTHENTICATED_URL_TEMPLATE="https://config.optimizely.com/datafiles/auth/%s.json",t.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT=[0,8,16,32,64,128,256,512],t.REQUEST_TIMEOUT_MS=6e4}),Ue=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var a=Xe.getLogger("DatafileManager");t.makeGetRequest=function(e,o){var s=new XMLHttpRequest;return{responsePromise:new Promise(function(t,r){var n,i;s.open("GET",e,!0),n=o,i=s,Object.keys(n).forEach(function(e){var t=n[e];i.setRequestHeader(e,t)}),s.onreadystatechange=function(){var e;4===s.readyState&&(0!==s.status?(e=function(e){if(null===(e=e.getAllResponseHeaders()))return{};var e=e.split("\r\n"),n={};return e.forEach(function(e){var t,r=e.indexOf(": ");-1<r&&(t=e.slice(0,r),0<(r=e.slice(r+2)).length&&(n[t]=r))}),n}(s),e={statusCode:s.status,body:s.responseText,headers:e},t(e)):r(new Error("Request error")))},s.timeout=Ae.REQUEST_TIMEOUT_MS,s.ontimeout=function(){a.error("Request timed out")},s.send()}),abort:function(){s.abort()}}}}),Le=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=(n.prototype.on=function(e,t){var r=this;this.listeners[e]||(this.listeners[e]={});var n=String(this.listenerId);return this.listenerId++,this.listeners[e][n]=t,function(){r.listeners[e]&&delete r.listeners[e][n]}},n.prototype.emit=function(e,t){var r=this.listeners[e];r&&Object.keys(r).forEach(function(e){(0,r[e])(t)})},n.prototype.removeAllListeners=function(){this.listeners={}},n);function n(){this.listeners={},this.listenerId=1}t.default=r}),be=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=(n.prototype.getDelay=function(){return 0===this.errorCount?0:1e3*Ae.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT[Math.min(Ae.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT.length-1,this.errorCount)]+Math.round(1e3*Math.random())},n.prototype.countError=function(){this.errorCount<Ae.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT.length-1&&this.errorCount++},n.prototype.reset=function(){this.errorCount=0},n);function n(){this.errorCount=0}t.default=r}),Se=t(function(e,t){var a=p&&p.__assign||function(){return(a=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},r=p&&p.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=r(Le),l=r(be),c=Xe.getLogger("DatafileManager");function n(e){return 200<=e&&e<400}var f={get:function(){return Promise.resolve("")},set:function(){return Promise.resolve()},contains:function(){return Promise.resolve(!1)},remove:function(){return Promise.resolve()}},r=(i.prototype.get=function(){return this.currentDatafile},i.prototype.start=function(){this.isStarted||(c.debug("Datafile manager started"),this.isStarted=!0,this.backoffController.reset(),this.setDatafileFromCacheIfAvailable(),this.syncDatafile())},i.prototype.stop=function(){return c.debug("Datafile manager stopped"),this.isStarted=!1,this.currentTimeout&&(clearTimeout(this.currentTimeout),this.currentTimeout=null),this.emitter.removeAllListeners(),this.currentRequest&&(this.currentRequest.abort(),this.currentRequest=null),Promise.resolve()},i.prototype.onReady=function(){return this.readyPromise},i.prototype.on=function(e,t){return this.emitter.on(e,t)},i.prototype.onRequestRejected=function(e){this.isStarted&&(this.backoffController.countError(),e instanceof Error?c.error("Error fetching datafile: %s",e.message,e):"string"==typeof e?c.error("Error fetching datafile: %s",e):c.error("Error fetching datafile"))},i.prototype.onRequestResolved=function(e){this.isStarted&&(void 0!==e.statusCode&&n(e.statusCode)?this.backoffController.reset():this.backoffController.countError(),this.trySavingLastModified(e.headers),""!==(e=this.getNextDatafileFromResponse(e))&&(c.info("Updating datafile from response"),this.currentDatafile=e,this.cache.set(this.cacheKey,e),this.isReadyPromiseSettled?(e={datafile:e},this.emitter.emit("update",e)):this.resolveReadyPromise()))},i.prototype.onRequestComplete=function(){this.isStarted&&(this.currentRequest=null,this.isReadyPromiseSettled||this.autoUpdate||this.rejectReadyPromise(new Error("Failed to become ready")),this.autoUpdate&&this.syncOnCurrentRequestComplete&&this.syncDatafile(),this.syncOnCurrentRequestComplete=!1)},i.prototype.syncDatafile=function(){var t=this,e={};this.lastResponseLastModified&&(e["if-modified-since"]=this.lastResponseLastModified),c.debug("Making datafile request to url %s with headers: %s",this.datafileUrl,function(){return JSON.stringify(e)}),this.currentRequest=this.makeGetRequest(this.datafileUrl,e);function r(){t.onRequestComplete()}this.currentRequest.responsePromise.then(function(e){t.onRequestResolved(e)},function(e){t.onRequestRejected(e)}).then(r,r),this.autoUpdate&&this.scheduleNextUpdate()},i.prototype.resolveReadyPromise=function(){this.readyPromiseResolver(),this.isReadyPromiseSettled=!0},i.prototype.rejectReadyPromise=function(e){this.readyPromiseRejecter(e),this.isReadyPromiseSettled=!0},i.prototype.scheduleNextUpdate=function(){var e=this,t=this.backoffController.getDelay(),t=Math.max(t,this.updateInterval);c.debug("Scheduling sync in %s ms",t),this.currentTimeout=setTimeout(function(){e.currentRequest?e.syncOnCurrentRequestComplete=!0:e.syncDatafile()},t)},i.prototype.getNextDatafileFromResponse=function(e){return c.debug("Response status code: %s",e.statusCode),void 0!==e.statusCode&&304!==e.statusCode&&n(e.statusCode)?e.body:""},i.prototype.trySavingLastModified=function(e){e=e["last-modified"]||e["Last-Modified"];void 0!==e&&(this.lastResponseLastModified=e,c.debug("Saved last modified header value from response: %s",this.lastResponseLastModified))},i.prototype.setDatafileFromCacheIfAvailable=function(){var t=this;this.cache.get(this.cacheKey).then(function(e){t.isStarted&&!t.isReadyPromiseSettled&&""!==e&&(c.debug("Using datafile from cache"),t.currentDatafile=e,t.resolveReadyPromise())})},i);function i(e){var r=this,t=a({},this.getConfigDefaults(),e),n=t.datafile,i=t.autoUpdate,o=void 0!==i&&i,s=t.sdkKey,e=t.updateInterval,i=void 0===e?Ae.DEFAULT_UPDATE_INTERVAL:e,e=t.urlTemplate,e=void 0===e?Ae.DEFAULT_URL_TEMPLATE:e,t=t.cache,t=void 0===t?f:t;this.cache=t,this.cacheKey="opt-datafile-"+s,this.isReadyPromiseSettled=!1,this.readyPromiseResolver=function(){},this.readyPromiseRejecter=function(){},this.readyPromise=new Promise(function(e,t){r.readyPromiseResolver=e,r.readyPromiseRejecter=t}),n?(this.currentDatafile=n,s||this.resolveReadyPromise()):this.currentDatafile="",this.isStarted=!1,this.datafileUrl=qe.sprintf(e,s),this.emitter=new u.default,this.autoUpdate=o,i>=Ae.MIN_UPDATE_INTERVAL?this.updateInterval=i:(c.warn("Invalid updateInterval %s, defaulting to %s",i,Ae.DEFAULT_UPDATE_INTERVAL),this.updateInterval=Ae.DEFAULT_UPDATE_INTERVAL),this.currentTimeout=null,this.currentRequest=null,this.backoffController=new l.default,this.syncOnCurrentRequestComplete=!1}t.default=r}),De=t(function(e,t){var n,r=p&&p.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=p&&p.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o,i=i(Se),r=(o=i.default,r(s,o),s.prototype.makeGetRequest=function(e,t){return Ue.makeGetRequest(e,t)},s.prototype.getConfigDefaults=function(){return{autoUpdate:!1}},s);function s(){return null!==o&&o.apply(this,arguments)||this}t.default=r}),Je=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.HttpPollingDatafileManager=De.default}),Ze=t(function(e){function t(e,t){for(var r,n,i=3&e.length,o=e.length-i,s=t,a=3432918353,u=461845907,l=0;l<o;)n=255&e.charCodeAt(l)|(255&e.charCodeAt(++l))<<8|(255&e.charCodeAt(++l))<<16|(255&e.charCodeAt(++l))<<24,++l,s=27492+(65535&(r=5*(65535&(s=(s^=n=(65535&(n=(n=(65535&n)*a+(((n>>>16)*a&65535)<<16)&4294967295)<<15|n>>>17))*u+(((n>>>16)*u&65535)<<16)&4294967295)<<13|s>>>19))+((5*(s>>>16)&65535)<<16)&4294967295))+((58964+(r>>>16)&65535)<<16);switch(n=0,i){case 3:n^=(255&e.charCodeAt(l+2))<<16;case 2:n^=(255&e.charCodeAt(l+1))<<8;case 1:s^=n=(65535&(n=(n=(65535&(n^=255&e.charCodeAt(l)))*a+(((n>>>16)*a&65535)<<16)&4294967295)<<15|n>>>17))*u+(((n>>>16)*u&65535)<<16)&4294967295}return s^=e.length,s=2246822507*(65535&(s^=s>>>16))+((2246822507*(s>>>16)&65535)<<16)&4294967295,s=3266489909*(65535&(s^=s>>>13))+((3266489909*(s>>>16)&65535)<<16)&4294967295,(s^=s>>>16)>>>0}var r;(r=t).v2=function(e,t){for(var r,n=e.length,i=t^n,o=0;4<=n;)r=1540483477*(65535&(r=255&e.charCodeAt(o)|(255&e.charCodeAt(++o))<<8|(255&e.charCodeAt(++o))<<16|(255&e.charCodeAt(++o))<<24))+((1540483477*(r>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16),n-=4,++o;switch(n){case 3:i^=(255&e.charCodeAt(o+2))<<16;case 2:i^=(255&e.charCodeAt(o+1))<<8;case 1:i=1540483477*(65535&(i^=255&e.charCodeAt(o)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0},r.v3=t,e.exports=r}),Ve=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var a=Xe,u=We,g=qe,n=Je,r=(ze=Ze)&&"object"==typeof ze&&"default"in ze?ze.default:ze,l=function(){return(l=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function c(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;for(var n=Array(e),i=0,t=0;t<r;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)n[i]=o[s];return n}var _={NOTSET:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4},f={CONDITION_EVALUATOR_ERROR:"%s: Error evaluating audience condition of type %s: %s",DATAFILE_AND_SDK_KEY_MISSING:"%s: You must provide at least one of sdkKey or datafile. Cannot start Optimizely",EXPERIMENT_KEY_NOT_IN_DATAFILE:"%s: Experiment key %s is not in datafile.",FEATURE_NOT_IN_DATAFILE:"%s: Feature key %s is not in datafile.",IMPROPERLY_FORMATTED_EXPERIMENT:"%s: Experiment key %s is improperly formatted.",INVALID_ATTRIBUTES:"%s: Provided attributes are in an invalid format.",INVALID_BUCKETING_ID:"%s: Unable to generate hash for bucketing ID %s: %s",INVALID_DATAFILE:"%s: Datafile is invalid - property %s: %s",INVALID_DATAFILE_MALFORMED:"%s: Datafile is invalid because it is malformed.",INVALID_CONFIG:"%s: Provided Optimizely config is in an invalid format.",INVALID_JSON:"%s: JSON object is not valid.",INVALID_ERROR_HANDLER:'%s: Provided "errorHandler" is in an invalid format.',INVALID_EVENT_DISPATCHER:'%s: Provided "eventDispatcher" is in an invalid format.',INVALID_EVENT_TAGS:"%s: Provided event tags are in an invalid format.",INVALID_EXPERIMENT_KEY:"%s: Experiment key %s is not in datafile. It is either invalid, paused, or archived.",INVALID_EXPERIMENT_ID:"%s: Experiment ID %s is not in datafile.",INVALID_GROUP_ID:"%s: Group ID %s is not in datafile.",INVALID_LOGGER:'%s: Provided "logger" is in an invalid format.',INVALID_ROLLOUT_ID:"%s: Invalid rollout ID %s attached to feature %s",INVALID_USER_ID:"%s: Provided user ID is in an invalid format.",INVALID_USER_PROFILE_SERVICE:"%s: Provided user profile service instance is in an invalid format: %s.",NO_DATAFILE_SPECIFIED:"%s: No datafile specified. Cannot start optimizely.",NO_JSON_PROVIDED:"%s: No JSON object to validate against schema.",NO_VARIATION_FOR_EXPERIMENT_KEY:"%s: No variation key %s defined in datafile for experiment %s.",UNDEFINED_ATTRIBUTE:"%s: Provided attribute: %s has an undefined value.",UNRECOGNIZED_ATTRIBUTE:"%s: Unrecognized attribute %s provided. Pruning before sending event to Optimizely.",UNABLE_TO_CAST_VALUE:"%s: Unable to cast value %s to type %s, returning null.",USER_NOT_IN_FORCED_VARIATION:"%s: User %s is not in the forced variation map. Cannot remove their forced variation.",USER_PROFILE_LOOKUP_ERROR:'%s: Error while looking up user profile for user ID "%s": %s.',USER_PROFILE_SAVE_ERROR:'%s: Error while saving user profile for user ID "%s": %s.',VARIABLE_KEY_NOT_IN_DATAFILE:'%s: Variable with key "%s" associated with feature with key "%s" is not in datafile.',VARIATION_ID_NOT_IN_DATAFILE:"%s: No variation ID %s defined in datafile for experiment %s.",VARIATION_ID_NOT_IN_DATAFILE_NO_EXPERIMENT:"%s: Variation ID %s is not in the datafile.",INVALID_INPUT_FORMAT:"%s: Provided %s is in an invalid format.",INVALID_DATAFILE_VERSION:"%s: This version of the JavaScript SDK does not support the given datafile version: %s",INVALID_VARIATION_KEY:"%s: Provided variation key is in an invalid format."},h={ACTIVATE_USER:"%s: Activating user %s in experiment %s.",DISPATCH_CONVERSION_EVENT:"%s: Dispatching conversion event to URL %s with params %s.",DISPATCH_IMPRESSION_EVENT:"%s: Dispatching impression event to URL %s with params %s.",DEPRECATED_EVENT_VALUE:"%s: Event value is deprecated in %s call.",EVENT_KEY_NOT_FOUND:"%s: Event key %s is not in datafile.",EXPERIMENT_NOT_RUNNING:"%s: Experiment %s is not running.",FEATURE_ENABLED_FOR_USER:"%s: Feature %s is enabled for user %s.",FEATURE_NOT_ENABLED_FOR_USER:"%s: Feature %s is not enabled for user %s.",FEATURE_HAS_NO_EXPERIMENTS:"%s: Feature %s is not attached to any experiments.",FAILED_TO_PARSE_VALUE:'%s: Failed to parse event value "%s" from event tags.',FAILED_TO_PARSE_REVENUE:'%s: Failed to parse revenue value "%s" from event tags.',FORCED_BUCKETING_FAILED:"%s: Variation key %s is not in datafile. Not activating user %s.",INVALID_OBJECT:"%s: Optimizely object is not valid. Failing %s.",INVALID_CLIENT_ENGINE:"%s: Invalid client engine passed: %s. Defaulting to node-sdk.",INVALID_VARIATION_ID:"%s: Bucketed into an invalid variation ID. Returning null.",NOTIFICATION_LISTENER_EXCEPTION:"%s: Notification listener for (%s) threw exception: %s",NO_ROLLOUT_EXISTS:"%s: There is no rollout of feature %s.",NOT_ACTIVATING_USER:"%s: Not activating user %s for experiment %s.",NOT_TRACKING_USER:"%s: Not tracking user %s.",PARSED_REVENUE_VALUE:'%s: Parsed revenue value "%s" from event tags.',PARSED_NUMERIC_VALUE:'%s: Parsed event value "%s" from event tags.',RETURNING_STORED_VARIATION:'%s: Returning previously activated variation "%s" of experiment "%s" for user "%s" from user profile.',ROLLOUT_HAS_NO_EXPERIMENTS:"%s: Rollout of feature %s has no experiments",SAVED_VARIATION:'%s: Saved variation "%s" of experiment "%s" for user "%s".',SAVED_VARIATION_NOT_FOUND:"%s: User %s was previously bucketed into variation with ID %s for experiment %s, but no matching variation was found.",SHOULD_NOT_DISPATCH_ACTIVATE:'%s: Experiment %s is not in "Running" state. Not activating user.',SKIPPING_JSON_VALIDATION:"%s: Skipping JSON schema validation.",TRACK_EVENT:"%s: Tracking event %s for user %s.",USER_ASSIGNED_TO_EXPERIMENT_BUCKET:"%s: Assigned bucket %s to user with bucketing ID %s.",USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP:"%s: User %s is in experiment %s of group %s.",USER_BUCKETED_INTO_TARGETING_RULE:"%s: User %s bucketed into targeting rule %s.",USER_IN_FEATURE_EXPERIMENT:"%s: User %s is in variation %s of experiment %s on the feature %s.",USER_IN_ROLLOUT:"%s: User %s is in rollout of feature %s.",USER_BUCKETED_INTO_EVERYONE_TARGETING_RULE:"%s: User %s bucketed into everyone targeting rule.",USER_NOT_BUCKETED_INTO_EVERYONE_TARGETING_RULE:"%s: User %s not bucketed into everyone targeting rule due to traffic allocation.",USER_NOT_BUCKETED_INTO_EXPERIMENT_IN_GROUP:"%s: User %s is not in experiment %s of group %s.",USER_NOT_BUCKETED_INTO_ANY_EXPERIMENT_IN_GROUP:"%s: User %s is not in any experiment of group %s.",USER_NOT_BUCKETED_INTO_TARGETING_RULE:"%s User %s not bucketed into targeting rule %s due to traffic allocation. Trying everyone rule.",USER_NOT_IN_FEATURE_EXPERIMENT:"%s: User %s is not in any experiment on the feature %s.",USER_NOT_IN_ROLLOUT:"%s: User %s is not in rollout of feature %s.",USER_FORCED_IN_VARIATION:"%s: User %s is forced in variation %s.",USER_MAPPED_TO_FORCED_VARIATION:"%s: Set variation %s for experiment %s and user %s in the forced variation map.",USER_DOESNT_MEET_CONDITIONS_FOR_TARGETING_RULE:"%s: User %s does not meet conditions for targeting rule %s.",USER_MEETS_CONDITIONS_FOR_TARGETING_RULE:"%s: User %s meets conditions for targeting rule %s.",USER_HAS_VARIATION:"%s: User %s is in variation %s of experiment %s.",USER_HAS_FORCED_VARIATION:"%s: Variation %s is mapped to experiment %s and user %s in the forced variation map.",USER_HAS_NO_VARIATION:"%s: User %s is in no variation of experiment %s.",USER_HAS_NO_FORCED_VARIATION:"%s: User %s is not in the forced variation map.",USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT:"%s: No experiment %s mapped to user %s in the forced variation map.",USER_NOT_IN_ANY_EXPERIMENT:"%s: User %s is not in any experiment of group %s.",USER_NOT_IN_EXPERIMENT:"%s: User %s does not meet conditions to be in experiment %s.",USER_RECEIVED_DEFAULT_VARIABLE_VALUE:'%s: User "%s" is not in any variation or rollout rule. Returning default value for variable "%s" of feature flag "%s".',FEATURE_NOT_ENABLED_RETURN_DEFAULT_VARIABLE_VALUE:'%s: Feature "%s" is not enabled for user %s. Returning the default variable value "%s".',VARIABLE_NOT_USED_RETURN_DEFAULT_VARIABLE_VALUE:'%s: Variable "%s" is not used in variation "%s". Returning default value.',USER_RECEIVED_VARIABLE_VALUE:'%s: Got variable value "%s" for variable "%s" of feature flag "%s"',VALID_DATAFILE:"%s: Datafile is valid.",VALID_USER_PROFILE_SERVICE:"%s: Valid user profile service provided.",VARIATION_REMOVED_FOR_USER:"%s: Variation mapped to experiment %s has been removed for user %s.",VARIABLE_REQUESTED_WITH_WRONG_TYPE:'%s: Requested variable type "%s", but variable is of type "%s". Use correct API to retrieve value. Returning None.',VALID_BUCKETING_ID:'%s: BucketingId is valid: "%s"',BUCKETING_ID_NOT_STRING:"%s: BucketingID attribute is not a string. Defaulted to userId",EVALUATING_AUDIENCE:'%s: Starting to evaluate audience "%s" with conditions: %s.',EVALUATING_AUDIENCES_COMBINED:'%s: Evaluating audiences for %s "%s": %s.',AUDIENCE_EVALUATION_RESULT:'%s: Audience "%s" evaluated to %s.',AUDIENCE_EVALUATION_RESULT_COMBINED:"%s: Audiences for %s %s collectively evaluated to %s.",MISSING_ATTRIBUTE_VALUE:'%s: Audience condition %s evaluated to UNKNOWN because no value was passed for user attribute "%s".',UNEXPECTED_CONDITION_VALUE:"%s: Audience condition %s evaluated to UNKNOWN because the condition value is not supported.",UNEXPECTED_TYPE:'%s: Audience condition %s evaluated to UNKNOWN because a value of type "%s" was passed for user attribute "%s".',UNEXPECTED_TYPE_NULL:'%s: Audience condition %s evaluated to UNKNOWN because a null value was passed for user attribute "%s".',UNKNOWN_CONDITION_TYPE:"%s: Audience condition %s has an unknown condition type. You may need to upgrade to a newer release of the Optimizely SDK.",UNKNOWN_MATCH_TYPE:"%s: Audience condition %s uses an unknown match type. You may need to upgrade to a newer release of the Optimizely SDK.",UPDATED_OPTIMIZELY_CONFIG:"%s: Updated Optimizely config to revision %s (project id %s)",OUT_OF_BOUNDS:'%s: Audience condition %s evaluated to UNKNOWN because the number value for user attribute "%s" is not in the range [-2^53, +2^53].',UNABLE_TO_ATTACH_UNLOAD:'%s: unable to bind optimizely.close() to page unload event: "%s"'},p={REVENUE:"revenue",VALUE:"value"},d={BOT_FILTERING:"$opt_bot_filtering",BUCKETING_ID:"$opt_bucketing_id",STICKY_BUCKETING_KEY:"$opt_experiment_bucket_map",USER_AGENT:"$opt_user_agent"},o=["node-sdk","react-sdk","javascript-sdk"],E=g.NOTIFICATION_TYPES,v={AB_TEST:"ab-test",FEATURE:"feature",FEATURE_TEST:"feature-test",FEATURE_VARIABLE:"feature-variable",ALL_FEATURE_VARIABLES:"all-feature-variables"},I={FEATURE_TEST:"feature-test",ROLLOUT:"rollout",EXPERIMENT:"experiment"},i={RULE:"rule",EXPERIMENT:"experiment"},y={BOOLEAN:"boolean",DOUBLE:"double",INTEGER:"integer",STRING:"string",JSON:"json"},s={V2:"2",V3:"3",V4:"4"},O=Object.freeze({__proto__:null,LOG_LEVEL:_,ERROR_MESSAGES:f,LOG_MESSAGES:h,RESERVED_EVENT_KEYWORDS:p,CONTROL_ATTRIBUTES:d,JAVASCRIPT_CLIENT_ENGINE:"javascript-sdk",NODE_CLIENT_ENGINE:"node-sdk",REACT_CLIENT_ENGINE:"react-sdk",NODE_CLIENT_VERSION:"4.4.3",VALID_CLIENT_ENGINES:o,NOTIFICATION_TYPES:E,DECISION_NOTIFICATION_TYPES:v,DECISION_SOURCES:I,AUDIENCE_EVALUATION_TYPES:i,FEATURE_VARIABLE_TYPES:y,DATAFILE_VERSIONS:s}),R="CONFIG_VALIDATOR",T=[s.V2,s.V3,s.V4],N={handleError:function(){}},m={dispatchEvent:function(e,t){var r,n,i=e.url,o=e.params;"POST"===e.httpVerb?((r=new XMLHttpRequest).open("POST",i,!0),r.setRequestHeader("Content-Type","application/json"),r.onreadystatechange=function(){if(4===r.readyState&&t&&"function"==typeof t)try{t({statusCode:r.status})}catch(e){}},r.send(JSON.stringify(o))):(i+="?wxhr=true",o&&(i+="&"+(n=o,Object.keys(n).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(n[e])}).join("&"))),(r=new XMLHttpRequest).open("GET",i,!0),r.onreadystatechange=function(){if(4===r.readyState&&t&&"function"==typeof t)try{t()}catch(e){}},r.send())}};function A(){}A.prototype.log=function(){};function U(e,t){if(!(e=e.experimentKeyMap[t]))throw new Error(g.sprintf(f.INVALID_EXPERIMENT_KEY,K,t));return e.id}function L(e,t){if(!(e=e.experimentKeyMap[t]))throw new Error(g.sprintf(f.INVALID_EXPERIMENT_KEY,K,t));return e.status}function b(e,t,r){return(t=e.experimentKeyMap[t]).variationKeyMap.hasOwnProperty(r)?t.variationKeyMap[r].id:null}function S(e,t){if(e.experimentKeyMap.hasOwnProperty(t)){e=e.experimentKeyMap[t];if(e)return e}throw new Error(g.sprintf(f.EXPERIMENT_KEY_NOT_IN_DATAFILE,K,t))}function D(e,t,r){if(e.featureKeyMap.hasOwnProperty(t)){e=e.featureKeyMap[t];if(e)return e}return r.log(_.ERROR,g.sprintf(f.FEATURE_NOT_IN_DATAFILE,K,t)),null}function V(e,t){return e.experimentFeatureMap.hasOwnProperty(t)}function P(e,t){if(!(e=e.experimentIdMap[t]))throw new Error(g.sprintf(f.INVALID_EXPERIMENT_ID,K,t));return e.layerId}function C(e,t,r){var n=e.attributeKeyMap[t],e=0===t.indexOf("$opt_");return n?(e&&r.log(_.WARN,g.sprintf("Attribute %s unexpectedly has reserved prefix %s; using attribute ID instead of reserved attribute name.",t,"$opt_")),n.id):e?t:(r.log(_.DEBUG,g.sprintf(f.UNRECOGNIZED_ATTRIBUTE,K,t)),null)}function F(e,t){return(t=e.eventKeyMap[t])?t.id:null}function M(e,t){return e.variationIdMap.hasOwnProperty(t)?e.variationIdMap[t].key:null}function x(e,t,r){if(e.experimentIdMap.hasOwnProperty(t)){e=e.experimentIdMap[t];if(e)return e}return r.log(_.ERROR,g.sprintf(f.INVALID_EXPERIMENT_ID,K,t)),null}function k(e){return e.__datafileStr}function w(e){var t;try{t=function(e){if(!e)throw new Error(g.sprintf(f.NO_DATAFILE_SPECIFIED,R));if("string"==typeof e)try{e=JSON.parse(e)}catch(e){throw new Error(g.sprintf(f.INVALID_DATAFILE_MALFORMED,R))}if("object"==typeof e&&!Array.isArray(e)&&null!==e&&-1===T.indexOf(e.version))throw new Error(g.sprintf(f.INVALID_DATAFILE_VERSION,R,e.version));return e}(e.datafile)}catch(e){return{configObj:null,error:e}}if(e.jsonSchemaValidator)try{e.jsonSchemaValidator.validate(t),e.logger.log(_.INFO,g.sprintf(h.VALID_DATAFILE,K))}catch(e){return{configObj:null,error:e}}else e.logger.log(_.INFO,g.sprintf(h.SKIPPING_JSON_VALIDATION,K));var r=[t];return"string"==typeof e.datafile&&r.push(e.datafile),{configObj:function(e,t){void 0===t&&(t=null);var r,n,i=(r=e,(n=G.assign({},r)).audiences=(r.audiences||[]).map(function(e){return G.assign({},e)}),n.experiments=(r.experiments||[]).map(function(e){return G.assign({},e)}),n.featureFlags=(r.featureFlags||[]).map(function(e){return G.assign({},e)}),n.groups=(r.groups||[]).map(function(e){var t=G.assign({},e);return t.experiments=(e.experiments||[]).map(function(e){return G.assign({},e)}),t}),n.rollouts=(r.rollouts||[]).map(function(e){var t=G.assign({},e);return t.experiments=(e.experiments||[]).map(function(e){return G.assign({},e)}),t}),n);return i.__datafileStr=null===t?JSON.stringify(e):t,(i.audiences||[]).forEach(function(e){e.conditions=JSON.parse(e.conditions)}),i.audiencesById=G.keyBy(i.audiences,"id"),G.assign(i.audiencesById,G.keyBy(i.typedAudiences,"id")),i.attributeKeyMap=G.keyBy(i.attributes,"key"),i.eventKeyMap=G.keyBy(i.events,"key"),i.groupIdMap=G.keyBy(i.groups,"id"),Object.keys(i.groupIdMap||{}).forEach(function(t){(i.groupIdMap[t].experiments||[]).forEach(function(e){i.experiments.push(G.assign(e,{groupId:t}))})}),i.rolloutIdMap=G.keyBy(i.rollouts||[],"id"),g.objectValues(i.rolloutIdMap||{}).forEach(function(e){(e.experiments||[]).forEach(function(e){i.experiments.push(e),e.variationKeyMap=G.keyBy(e.variations,"key")})}),i.experimentKeyMap=G.keyBy(i.experiments,"key"),i.experimentIdMap=G.keyBy(i.experiments,"id"),i.variationIdMap={},i.variationVariableUsageMap={},(i.experiments||[]).forEach(function(e){e.variationKeyMap=G.keyBy(e.variations,"key"),G.assign(i.variationIdMap,G.keyBy(e.variations,"id")),g.objectValues(e.variationKeyMap||{}).forEach(function(e){e.variables&&(i.variationVariableUsageMap[e.id]=G.keyBy(e.variables,"id"))})}),i.experimentFeatureMap={},i.featureKeyMap=G.keyBy(i.featureFlags||[],"key"),g.objectValues(i.featureKeyMap||{}).forEach(function(t){t.variables.forEach(function(e){e.type===y.STRING&&e.subType===y.JSON&&(e.type=y.JSON,delete e.subType)}),t.variableKeyMap=G.keyBy(t.variables,"key"),(t.experimentIds||[]).forEach(function(e){i.experimentFeatureMap[e]?i.experimentFeatureMap[e].push(t.id):i.experimentFeatureMap[e]=[t.id];e=i.experimentIdMap[e];e.groupId&&!t.groupId&&(t.groupId=e.groupId)})}),i}.apply(void 0,r),error:null}}var B={createLogger:function(e){return new a.ConsoleLogHandler(e)},createNoOpLogger:function(){return new A}},j=Math.pow(2,53),G={assign:function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(!e)return{};if("function"==typeof Object.assign)return Object.assign.apply(Object,c([e],t));for(var n=Object(e),i=0;i<t.length;i++){var o=t[i];if(null!=o)for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(n[s]=o[s])}return n},currentTimestamp:function(){return Math.round((new Date).getTime())},isSafeInteger:function(e){return"number"==typeof e&&Math.abs(e)<=j},keyBy:function(e,t){return e?g.keyBy(e,function(e){return e[t]}):{}},uuid:g.generateUUID,isNumber:function(e){return"number"==typeof e}},K="PROJECT_CONFIG",Y=U,H=b,z=S;function X(e,t){var r,n,u,i,l;this.experimentsMap=(i=((u=e).rollouts||[]).reduce(function(t,e){return e.experiments.forEach(function(e){t[e.id]=!0}),t},{}),l=(u.featureFlags||[]).reduce(function(e,t){return e[t.id]=t.variables,e},{}),(u.experiments||[]).reduce(function(e,a){return i[a.id]||(e[a.key]={id:a.id,key:a.key,variationsMap:(a.variations||[]).reduce(function(e,t){return e[t.key]={id:t.id,key:t.key,variablesMap:(r=u,n=t,i=a.id,o=l,r=r.experimentFeatureMap[i],i={},r&&(r=o[r],s=(n.variables||[]).reduce(function(e,t){return e[t.id]={id:t.id,value:t.value},e},{}),i=(r||[]).reduce(function(e,t){var r=s[t.id],r=n.featureEnabled&&r?r.value:t.defaultValue;return e[t.key]={id:t.id,key:t.key,type:t.type,value:r},e},{})),i)},V(u,a.id)&&(e[t.key].featureEnabled=t.featureEnabled),e;var r,n,i,o,s},{})}),e},{})),this.featuresMap=(r=e,n=this.experimentsMap,(r.featureFlags||[]).reduce(function(e,t){return e[t.key]={id:t.id,key:t.key,experimentsMap:(t.experimentIds||[]).reduce(function(e,t){t=r.experimentIdMap[t].key;return e[t]=n[t],e},{}),variablesMap:(t.variables||[]).reduce(function(e,t){return e[t.key]={id:t.id,key:t.key,type:t.type,value:t.defaultValue},e},{})},e},{})),this.revision=e.revision,this.__datafile=t}X.prototype.getDatafile=function(){return this.__datafile};var q={OptimizelyConfig:X},W=a.getLogger();function J(e,t){return e instanceof Error?e.message:t||"Unknown error"}function Z(e){try{this.__initialize(e)}catch(e){W.error(e),this.__updateListeners=[],this.__configObj=null,this.__optimizelyConfigObj=null,this.__readyPromise=Promise.resolve({success:!1,reason:J(e,"Error in initialize")})}}Z.prototype.__initialize=function(e){if(this.__updateListeners=[],this.jsonSchemaValidator=e.jsonSchemaValidator,!e.datafile&&!e.sdkKey){this.__configObj=null;var t=new Error(g.sprintf(f.DATAFILE_AND_SDK_KEY_MISSING,"PROJECT_CONFIG_MANAGER"));return this.__readyPromise=Promise.resolve({success:!1,reason:J(t)}),void W.error(t)}var r;e.datafile&&!(r=this.__handleNewDatafile(e.datafile))||(this.__configObj=null),e.sdkKey?(t={sdkKey:e.sdkKey},this.__validateDatafileOptions(e.datafileOptions)&&G.assign(t,e.datafileOptions),this.__configObj&&(t.datafile=k(this.__configObj)),this.datafileManager=new n.HttpPollingDatafileManager(t),this.datafileManager.start(),this.__readyPromise=this.datafileManager.onReady().then(this.__onDatafileManagerReadyFulfill.bind(this),this.__onDatafileManagerReadyReject.bind(this)),this.datafileManager.on("update",this.__onDatafileManagerUpdate.bind(this))):this.__configObj?this.__readyPromise=Promise.resolve({success:!0}):this.__readyPromise=Promise.resolve({success:!1,reason:J(r,"Invalid datafile")})},Z.prototype.__onDatafileManagerReadyFulfill=function(){var e=this.__handleNewDatafile(this.datafileManager.get());return e?{success:!1,reason:J(e)}:{success:!0}},Z.prototype.__onDatafileManagerReadyReject=function(e){return{success:!1,reason:J(e,"Failed to become ready")}},Z.prototype.__onDatafileManagerUpdate=function(){this.__handleNewDatafile(this.datafileManager.get())},Z.prototype.__validateDatafileOptions=function(e){return void 0===e||"object"==typeof e&&null!==e},Z.prototype.__handleNewDatafile=function(e){var e=w({datafile:e,jsonSchemaValidator:this.jsonSchemaValidator,logger:W}),t=e.configObj,e=e.error;return e?W.error(e):(this.__configObj?this.__configObj.revision:"null")!==t.revision&&(this.__configObj=t,this.__optimizelyConfigObj=new q.OptimizelyConfig(this.__configObj,k(this.__configObj)),this.__updateListeners.forEach(function(e){e(t)})),e},Z.prototype.getConfig=function(){return this.__configObj},Z.prototype.getOptimizelyConfig=function(){return this.__optimizelyConfigObj},Z.prototype.onReady=function(){return this.__readyPromise},Z.prototype.onUpdate=function(t){return this.__updateListeners.push(t),function(){var e=this.__updateListeners.indexOf(t);-1<e&&this.__updateListeners.splice(e,1)}.bind(this)},Z.prototype.stop=function(){this.datafileManager&&this.datafileManager.stop(),this.__updateListeners=[]};var $=(Q.prototype.addNotificationListener=function(e,t){try{if(!(-1<g.objectValues(E).indexOf(e)))return-1;this.notificationListeners[e]||(this.notificationListeners[e]=[]);var r=!1;if((this.notificationListeners[e]||[]).forEach(function(e){e.callback!==t||(r=!0)}),r)return-1;this.notificationListeners[e].push({id:this.listenerId,callback:t});var n=this.listenerId;return this.listenerId+=1,n}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),-1}},Q.prototype.removeNotificationListener=function(n){var i,o,e=this;try{if(Object.keys(this.notificationListeners).some(function(r){return(e.notificationListeners[r]||[]).every(function(e,t){return e.id!==n||(i=t,o=r,!1)}),void 0!==i&&void 0!==o}),void 0!==i&&void 0!==o)return this.notificationListeners[o].splice(i,1),!0}catch(n){this.logger.log(_.ERROR,n.message),this.errorHandler.handleError(n)}return!1},Q.prototype.clearAllNotificationListeners=function(){var t=this;try{g.objectValues(E).forEach(function(e){t.notificationListeners[e]=[]})}catch(t){this.logger.log(_.ERROR,t.message),this.errorHandler.handleError(t)}},Q.prototype.clearNotificationListeners=function(e){try{this.notificationListeners[e]=[]}catch(e){this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e)}},Q.prototype.sendNotifications=function(r,n){var i=this;try{(this.notificationListeners[r]||[]).forEach(function(e){var t=e.callback;try{t(n)}catch(e){i.logger.log(_.ERROR,g.sprintf(h.NOTIFICATION_LISTENER_EXCEPTION,"NOTIFICATION_CENTER",r,e.message))}})}catch(r){this.logger.log(_.ERROR,r.message),this.errorHandler.handleError(r)}},Q);function Q(e){var t=this;this.logger=e.logger,this.errorHandler=e.errorHandler,this.notificationListeners={},g.objectValues(E).forEach(function(e){t.notificationListeners[e]=[]}),this.listenerId=1}var ee=Math.pow(2,32),te={bucket:function(e){var t=e.experimentKeyMap[e.experimentKey].groupId;if(t){var r=e.groupIdMap[t];if(!r)throw new Error(g.sprintf(f.INVALID_GROUP_ID,"BUCKETER",t));if("random"===r.policy){var n=this.bucketUserIntoExperiment(r,e.bucketingId,e.userId,e.logger);if(null===n){r=g.sprintf(h.USER_NOT_IN_ANY_EXPERIMENT,"BUCKETER",e.userId,t);return e.logger.log(_.INFO,r),null}if(n!==e.experimentId){var i=g.sprintf(h.USER_NOT_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",e.userId,e.experimentKey,t);return e.logger.log(_.INFO,i),null}i=g.sprintf(h.USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",e.userId,e.experimentKey,t);e.logger.log(_.INFO,i)}}t=g.sprintf("%s%s",e.bucketingId,e.experimentId),i=this._generateBucketValue(t),t=g.sprintf(h.USER_ASSIGNED_TO_EXPERIMENT_BUCKET,"BUCKETER",i,e.userId);e.logger.log(_.DEBUG,t);i=this._findBucket(i,e.trafficAllocationConfig);return e.variationIdMap.hasOwnProperty(i)?i:(i&&(i=g.sprintf(h.INVALID_VARIATION_ID,"BUCKETER"),e.logger.log(_.WARNING,i)),null)},bucketUserIntoExperiment:function(e,t,r,n){t=g.sprintf("%s%s",t,e.id),t=this._generateBucketValue(t);n.log(_.DEBUG,g.sprintf(h.USER_ASSIGNED_TO_EXPERIMENT_BUCKET,"BUCKETER",t,r));e=e.trafficAllocation;return this._findBucket(t,e)},_findBucket:function(e,t){for(var r=0;r<t.length;r++)if(e<t[r].endOfRange)return t[r].entityId;return null},_generateBucketValue:function(e){try{var t=r.v3(e,1);return parseInt(t/ee*1e4,10)}catch(t){throw new Error(g.sprintf(f.INVALID_BUCKETING_ID,"BUCKETER",e,t.message))}}},re=["and","or","not"];function ne(e,t){if(Array.isArray(e)){var r=e[0],n=e.slice(1);switch("string"==typeof r&&-1===re.indexOf(r)&&(r="or",n=e),r){case"and":return function(e,t){var r=!1;if(Array.isArray(e)){for(var n=0;n<e.length;n++){var i=ne(e[n],t);if(!1===i)return!1;null===i&&(r=!0)}return!r||null}return null}(n,t);case"not":return function(e,t){if(Array.isArray(e)&&0<e.length){t=ne(e[0],t);return null===t?null:!t}return null}(n,t);default:return function(e,t){var r=!1;if(Array.isArray(e)){for(var n=0;n<e.length;n++){var i=ne(e[n],t);if(!0===i)return!0;null===i&&(r=!0)}return!!r&&null}return null}(n,t)}}return t(e)}var ie=a.getLogger();function oe(e){return/^\d+$/.test(e)}function se(e){var t=e.indexOf("-"),e=e.indexOf("+");return!(t<0)&&(e<0||t<e)}function ae(e){var t=e.indexOf("-"),e=e.indexOf("+");return!(e<0)&&(t<0||e<t)}function ue(e){var t=e,r="";if(/\s/.test(e))return ie.warn(h.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",e),null;if(se(e)?(t=e.substring(0,e.indexOf("-")),r=e.substring(e.indexOf("-")+1)):ae(e)&&(t=e.substring(0,e.indexOf("+")),r=e.substring(e.indexOf("+")+1)),"string"!=typeof t||"string"!=typeof r)return null;var n=t.split(".").length-1;if(2<n)return ie.warn(h.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",e),null;t=t.split(".");if(t.length!=1+n)return ie.warn(h.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",e),null;for(var i=0,o=t;i<o.length;i++)if(!oe(o[i]))return ie.warn(h.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",e),null;return r&&t.push(r),t}var le="CUSTOM_ATTRIBUTE_CONDITION_EVALUATOR",ce=a.getLogger(),fe=["exact","exists","gt","ge","lt","le","substring","semver_eq","semver_lt","semver_le","semver_gt","semver_ge"],pe={};function de(e){return"string"==typeof e||"boolean"==typeof e||G.isNumber(e)}function Ee(e,t){var r=e.value,n=typeof r,i=e.name,o=t[i],t=typeof o;return!de(r)||G.isNumber(r)&&!G.isSafeInteger(r)?(ce.warn(h.UNEXPECTED_CONDITION_VALUE,le,JSON.stringify(e)),null):null===o?(ce.debug(h.UNEXPECTED_TYPE_NULL,le,JSON.stringify(e),i),null):de(o)&&n==t?G.isNumber(o)&&!G.isSafeInteger(o)?(ce.warn(h.OUT_OF_BOUNDS,le,JSON.stringify(e),i),null):r===o:(ce.warn(h.UNEXPECTED_TYPE,le,JSON.stringify(e),t,i),null)}function ge(e,t){var r=e.name,n=t[r],i=typeof n,t=e.value;return null!==t&&G.isSafeInteger(t)?null===n?(ce.debug(h.UNEXPECTED_TYPE_NULL,le,JSON.stringify(e),r),0):G.isNumber(n)?G.isSafeInteger(n)||(ce.warn(h.OUT_OF_BOUNDS,le,JSON.stringify(e),r),0):(ce.warn(h.UNEXPECTED_TYPE,le,JSON.stringify(e),i,r),0):(ce.warn(h.UNEXPECTED_CONDITION_VALUE,le,JSON.stringify(e)),0)}function _e(e,t){var r=e.name,n=t[r],i=typeof n,t=e.value;return"string"!=typeof t?(ce.warn(h.UNEXPECTED_CONDITION_VALUE,le,JSON.stringify(e)),null):null===n?(ce.debug(h.UNEXPECTED_TYPE_NULL,le,JSON.stringify(e),r),null):"string"!=typeof n?(ce.warn(h.UNEXPECTED_TYPE,le,JSON.stringify(e),i,r),null):function(e,t){var r=ue(t),n=ue(e);if(!r||!n)return null;for(var i=r.length,o=0;o<n.length;o++){if(i<=o)return se(e)||ae(e)?1:-1;if(oe(r[o])){var s=parseInt(r[o]),a=parseInt(n[o]);if(a<s)return 1;if(s<a)return-1}else{if(r[o]<n[o])return se(e)&&!se(t)?1:-1;if(r[o]>n[o])return!se(e)&&se(t)?-1:1}}return se(t)&&!se(e)?-1:0}(t,n)}pe.exact=Ee,pe.exists=function(e,t){return null!=t[e.name]},pe.gt=function(e,t){var r=t[e.name],n=e.value;return ge(e,t)&&null!==n?n<r:null},pe.ge=function(e,t){var r=t[e.name],n=e.value;return ge(e,t)&&null!==n?n<=r:null},pe.lt=function(e,t){var r=t[e.name],n=e.value;return ge(e,t)&&null!==n?r<n:null},pe.le=function(e,t){var r=t[e.name],n=e.value;return ge(e,t)&&null!==n?r<=n:null},pe.substring=function(e,t){var r=e.name,n=t[e.name],i=typeof n,t=e.value;return"string"!=typeof t?(ce.warn(h.UNEXPECTED_CONDITION_VALUE,le,JSON.stringify(e)),null):null===n?(ce.debug(h.UNEXPECTED_TYPE_NULL,le,JSON.stringify(e),r),null):"string"!=typeof n?(ce.warn(h.UNEXPECTED_TYPE,le,JSON.stringify(e),i,r),null):-1!==n.indexOf(t)},pe.semver_eq=function(e,t){t=_e(e,t);return null===t?null:0===t},pe.semver_gt=function(e,t){t=_e(e,t);return null===t?null:0<t},pe.semver_ge=function(e,t){t=_e(e,t);return null===t?null:0<=t},pe.semver_lt=function(e,t){t=_e(e,t);return null===t?null:t<0},pe.semver_le=function(e,t){t=_e(e,t);return null===t?null:t<=0};var he=Object.freeze({__proto__:null,evaluate:function(e,t){var r=e.match;if(void 0!==r&&-1===fe.indexOf(r))return ce.warn(h.UNKNOWN_MATCH_TYPE,le,JSON.stringify(e)),null;var n=e.name;return t.hasOwnProperty(n)||"exists"==r?(r&&pe[r]||Ee)(e,t):(ce.debug(h.MISSING_ATTRIBUTE_VALUE,le,JSON.stringify(e),n),null)}}),ve=a.getLogger();function Ie(e){this.typeToEvaluatorMap=G.assign({},e,{custom_attribute:he})}function ye(e){return"string"==typeof e&&""!==e}Ie.prototype.evaluate=function(e,n,i){if(!e||0===e.length)return!0;i=i||{};var t=function(e){var t=n[e];if(t){ve.log(_.DEBUG,g.sprintf(h.EVALUATING_AUDIENCE,"AUDIENCE_EVALUATOR",e,JSON.stringify(t.conditions)));var r=ne(t.conditions,this.evaluateConditionWithUserAttributes.bind(this,i)),t=null===r?"UNKNOWN":r.toString().toUpperCase();return ve.log(_.DEBUG,g.sprintf(h.AUDIENCE_EVALUATION_RESULT,"AUDIENCE_EVALUATOR",e,t)),r}return null}.bind(this);return ne(e,t)||!1},Ie.prototype.evaluateConditionWithUserAttributes=function(e,t){var r=this.typeToEvaluatorMap[t.type];if(!r)return ve.log(_.WARNING,g.sprintf(h.UNKNOWN_CONDITION_TYPE,"AUDIENCE_EVALUATOR",JSON.stringify(t))),null;try{return r.evaluate(t,e,ve)}catch(e){ve.log(_.ERROR,g.sprintf(f.CONDITION_EVALUATOR_ERROR,"AUDIENCE_EVALUATOR",t.type,e.message))}return null};var Oe="DECISION_SERVICE",Re=f,Te=_,Ne=h,me=I,Ae=i;function Ue(e){this.audienceEvaluator=new Ie(e.UNSTABLE_conditionEvaluators),this.forcedVariationMap={},this.logger=e.logger,this.userProfileService=e.userProfileService||null}Ue.prototype.getVariation=function(e,t,r,n){var i=this._getBucketingId(r,n);if(!this.__checkIfExperimentIsActive(e,t))return null;var o=e.experimentKeyMap[t],s=this.getForcedVariation(e,t,r);if(s)return s;var a=this.__getWhitelistedVariation(o,r);if(a)return a.key;s=this.__resolveExperimentBucketMap(r,n);if(a=this.__getStoredVariation(e,o,r,s))return this.logger.log(Te.INFO,g.sprintf(Ne.RETURNING_STORED_VARIATION,Oe,a.key,t,r)),a.key;if(!this.__checkIfUserIsInAudience(e,t,Ae.EXPERIMENT,r,n,"")){n=g.sprintf(Ne.USER_NOT_IN_EXPERIMENT,Oe,r,t);return this.logger.log(Te.INFO,n),null}i=this.__buildBucketerParams(e,t,i,r),i=te.bucket(i);if(!(a=e.variationIdMap[i])){i=g.sprintf(Ne.USER_HAS_NO_VARIATION,Oe,r,t);return this.logger.log(Te.DEBUG,i),null}t=g.sprintf(Ne.USER_HAS_VARIATION,Oe,r,a.key,t);return this.logger.log(Te.INFO,t),this.__saveUserProfile(o,a,r,s),a.key},Ue.prototype.__resolveExperimentBucketMap=function(e,t){t=t||{};e=this.__getUserProfile(e)||{},t=t[d.STICKY_BUCKETING_KEY];return G.assign({},e.experiment_bucket_map,t)},Ue.prototype.__checkIfExperimentIsActive=function(e,t){if("Running"===L(e,t))return!0;t=g.sprintf(Ne.EXPERIMENT_NOT_RUNNING,Oe,t);return this.logger.log(Te.INFO,t),!1},Ue.prototype.__getWhitelistedVariation=function(e,t){if(e.forcedVariations&&e.forcedVariations.hasOwnProperty(t)){var r=e.forcedVariations[t];if(e.variationKeyMap.hasOwnProperty(r)){var n=g.sprintf(Ne.USER_FORCED_IN_VARIATION,Oe,t,r);return this.logger.log(Te.INFO,n),e.variationKeyMap[r]}t=g.sprintf(Ne.FORCED_BUCKETING_FAILED,Oe,r,t);return this.logger.log(Te.ERROR,t),null}return null},Ue.prototype.__checkIfUserIsInAudience=function(e,t,r,n,i,o){var s=function(e,t){e=e.experimentKeyMap[t];if(!e)throw new Error(g.sprintf(f.INVALID_EXPERIMENT_KEY,K,t));return e.audienceConditions||e.audienceIds}(e,t),e=e.audiencesById;this.logger.log(Te.DEBUG,g.sprintf(Ne.EVALUATING_AUDIENCES_COMBINED,Oe,r,o||t,JSON.stringify(s)));i=this.audienceEvaluator.evaluate(s,e,i);return this.logger.log(Te.INFO,g.sprintf(Ne.AUDIENCE_EVALUATION_RESULT_COMBINED,Oe,r,o||t,i.toString().toUpperCase())),i},Ue.prototype.__buildBucketerParams=function(e,t,r,n){var i={};return i.experimentKey=t,i.experimentId=Y(e,t),i.userId=n,i.trafficAllocationConfig=function(e,t){e=e.experimentKeyMap[t];if(!e)throw new Error(g.sprintf(f.INVALID_EXPERIMENT_KEY,K,t));return e.trafficAllocation}(e,t),i.experimentKeyMap=e.experimentKeyMap,i.groupIdMap=e.groupIdMap,i.variationIdMap=e.variationIdMap,i.logger=this.logger,i.bucketingId=r,i},Ue.prototype.__getStoredVariation=function(e,t,r,n){if(n.hasOwnProperty(t.id)){var i=n[t.id],n=i.variation_id;if(e.variationIdMap.hasOwnProperty(n))return e.variationIdMap[i.variation_id];this.logger.log(Te.INFO,g.sprintf(Ne.SAVED_VARIATION_NOT_FOUND,Oe,r,n,t.key))}return null},Ue.prototype.__getUserProfile=function(e){var t={user_id:e,experiment_bucket_map:{}};if(!this.userProfileService)return t;try{return this.userProfileService.lookup(e)}catch(t){this.logger.log(Te.ERROR,g.sprintf(Re.USER_PROFILE_LOOKUP_ERROR,Oe,e,t.message))}},Ue.prototype.__saveUserProfile=function(e,t,r,n){if(this.userProfileService)try{n[e.id]={variation_id:t.id},this.userProfileService.save({user_id:r,experiment_bucket_map:n}),this.logger.log(Te.INFO,g.sprintf(Ne.SAVED_VARIATION,Oe,t.key,e.key,r))}catch(e){this.logger.log(Te.ERROR,g.sprintf(Re.USER_PROFILE_SAVE_ERROR,Oe,r,e.message))}},Ue.prototype.getVariationForFeature=function(e,t,r,n){var i=this._getVariationForFeatureExperiment(e,t,r,n);if(null!==i.variation)return i;n=this._getVariationForRollout(e,t,r,n);return null!==n.variation?this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_IN_ROLLOUT,Oe,r,t.key)):this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_NOT_IN_ROLLOUT,Oe,r,t.key)),n},Ue.prototype._getVariationForFeatureExperiment=function(e,t,r,n){var i,o=null,s=null;t.hasOwnProperty("groupId")?(i=e.groupIdMap[t.groupId])&&(o=this._getExperimentInGroup(e,i,r))&&-1!==t.experimentIds.indexOf(o.id)&&(s=this.getVariation(e,o.key,r,n)):0<t.experimentIds.length?(o=x(e,t.experimentIds[0],this.logger))&&(s=this.getVariation(e,o.key,r,n)):this.logger.log(Te.DEBUG,g.sprintf(Ne.FEATURE_HAS_NO_EXPERIMENTS,Oe,t.key));t=null;return null!==s&&null!==o&&(t=o.variationKeyMap[s]),{experiment:o,variation:t,decisionSource:me.FEATURE_TEST}},Ue.prototype._getExperimentInGroup=function(e,t,r){var n=te.bucketUserIntoExperiment(t,r,r,this.logger);if(n){this.logger.log(Te.INFO,g.sprintf(Ne.USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP,Oe,r,n,t.id));n=x(e,n,this.logger);if(n)return n}return this.logger.log(Te.INFO,g.sprintf(Ne.USER_NOT_BUCKETED_INTO_ANY_EXPERIMENT_IN_GROUP,Oe,r,t.id)),null},Ue.prototype._getVariationForRollout=function(e,t,r,n){if(!t.rolloutId)return this.logger.log(Te.DEBUG,g.sprintf(Ne.NO_ROLLOUT_EXISTS,Oe,t.key)),{experiment:null,variation:null,decisionSource:me.ROLLOUT};var i=e.rolloutIdMap[t.rolloutId];if(!i)return this.logger.log(Te.ERROR,g.sprintf(Re.INVALID_ROLLOUT_ID,Oe,t.rolloutId,t.key)),{experiment:null,variation:null,decisionSource:me.ROLLOUT};if(0===i.experiments.length)return this.logger.log(Te.ERROR,g.sprintf(Ne.ROLLOUT_HAS_NO_EXPERIMENTS,Oe,t.rolloutId)),{experiment:null,variation:null,decisionSource:me.ROLLOUT};for(var o,s,a,u,l,c=this._getBucketingId(r,n),f=i.experiments.length-1,p=0;p<f;p++){if(o=e.experimentKeyMap[i.experiments[p].key],l=p+1,this.__checkIfUserIsInAudience(e,o.key,Ae.RULE,r,n,l)){if(this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_MEETS_CONDITIONS_FOR_TARGETING_RULE,Oe,r,l)),s=this.__buildBucketerParams(e,o.key,c,r),a=te.bucket(s),u=e.variationIdMap[a])return this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_BUCKETED_INTO_TARGETING_RULE,Oe,r,l)),{experiment:o,variation:u,decisionSource:me.ROLLOUT};this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_NOT_BUCKETED_INTO_TARGETING_RULE,Oe,r,l));break}this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_DOESNT_MEET_CONDITIONS_FOR_TARGETING_RULE,Oe,r,l))}t=e.experimentKeyMap[i.experiments[f].key];if(this.__checkIfUserIsInAudience(e,t.key,Ae.RULE,r,n,"Everyone Else")){if(this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_MEETS_CONDITIONS_FOR_TARGETING_RULE,Oe,r,"Everyone Else")),s=this.__buildBucketerParams(e,t.key,c,r),a=te.bucket(s),u=e.variationIdMap[a])return this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_BUCKETED_INTO_EVERYONE_TARGETING_RULE,Oe,r)),{experiment:t,variation:u,decisionSource:me.ROLLOUT};this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_NOT_BUCKETED_INTO_EVERYONE_TARGETING_RULE,Oe,r))}return{experiment:null,variation:null,decisionSource:me.ROLLOUT}},Ue.prototype._getBucketingId=function(e,t){return null!=t&&"object"==typeof t&&t.hasOwnProperty(d.BUCKETING_ID)&&("string"==typeof t[d.BUCKETING_ID]?(e=t[d.BUCKETING_ID],this.logger.log(Te.DEBUG,g.sprintf(Ne.VALID_BUCKETING_ID,Oe,e))):this.logger.log(Te.WARNING,g.sprintf(Ne.BUCKETING_ID_NOT_STRING,Oe))),e},Ue.prototype.removeForcedVariation=function(e,t,r){if(!e)throw new Error(g.sprintf(Re.INVALID_USER_ID,Oe));if(!this.forcedVariationMap.hasOwnProperty(e))throw new Error(g.sprintf(Re.USER_NOT_IN_FORCED_VARIATION,Oe,e));delete this.forcedVariationMap[e][t],this.logger.log(Te.DEBUG,g.sprintf(Ne.VARIATION_REMOVED_FOR_USER,Oe,r,e))},Ue.prototype.__setInForcedVariationMap=function(e,t,r){this.forcedVariationMap.hasOwnProperty(e)||(this.forcedVariationMap[e]={}),this.forcedVariationMap[e][t]=r,this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_MAPPED_TO_FORCED_VARIATION,Oe,r,t,e))},Ue.prototype.getForcedVariation=function(e,t,r){var n,i=this.forcedVariationMap[r];if(!i)return this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_HAS_NO_FORCED_VARIATION,Oe,r)),null;try{var o=z(e,t);if(!o.hasOwnProperty("id"))return this.logger.log(Te.ERROR,g.sprintf(Re.IMPROPERLY_FORMATTED_EXPERIMENT,Oe,t)),null;n=o.id}catch(e){return this.logger.log(Te.ERROR,e.message),null}i=i[n];if(!i)return this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT,Oe,t,r)),null;i=M(e,i);return i?this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_HAS_FORCED_VARIATION,Oe,i,t,r)):this.logger.log(Te.DEBUG,g.sprintf(Ne.USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT,Oe,t,r)),i},Ue.prototype.setForcedVariation=function(e,t,r,n){if(null!=n&&!ye(n))return this.logger.log(Te.ERROR,g.sprintf(Re.INVALID_VARIATION_KEY,Oe)),!1;var i;try{var o=z(e,t);if(!o.hasOwnProperty("id"))return this.logger.log(Te.ERROR,g.sprintf(Re.IMPROPERLY_FORMATTED_EXPERIMENT,Oe,t)),!1;i=o.id}catch(e){return this.logger.log(Te.ERROR,e.message),!1}if(null==n)try{return this.removeForcedVariation(r,i,t,this.logger),!0}catch(e){return this.logger.log(Te.ERROR,e.message),!1}var s=H(e,t,n);if(!s)return this.logger.log(Te.ERROR,g.sprintf(Re.NO_VARIATION_FOR_EXPERIMENT_KEY,Oe,n,t)),!1;try{return this.__setInForcedVariationMap(r,i,s),!0}catch(e){return this.logger.log(Te.ERROR,e.message),!1}};var Le=p.REVENUE,be=p.VALUE;function Se(e,t){if(e.hasOwnProperty(Le)){var r=e[Le],e=void 0;return"string"==typeof r?(e=parseInt(r),isNaN(e)?(t.log(_.INFO,g.sprintf(h.FAILED_TO_PARSE_REVENUE,"EVENT_TAG_UTILS",r)),null):(t.log(_.INFO,g.sprintf(h.PARSED_REVENUE_VALUE,"EVENT_TAG_UTILS",e)),e)):"number"==typeof r?(e=r,t.log(_.INFO,g.sprintf(h.PARSED_REVENUE_VALUE,"EVENT_TAG_UTILS",e)),e):null}return null}function De(e,t){if(e.hasOwnProperty(be)){var r=e[be],e=void 0;return"string"==typeof r?(e=parseFloat(r),isNaN(e)?(t.log(_.INFO,g.sprintf(h.FAILED_TO_PARSE_VALUE,"EVENT_TAG_UTILS",r)),null):(t.log(_.INFO,g.sprintf(h.PARSED_NUMERIC_VALUE,"EVENT_TAG_UTILS",e)),e)):"number"==typeof r?(e=r,t.log(_.INFO,g.sprintf(h.PARSED_NUMERIC_VALUE,"EVENT_TAG_UTILS",e)),e):null}return null}function Ve(e,t){return"string"==typeof e&&("string"==typeof t||"boolean"==typeof t||G.isNumber(t)&&G.isSafeInteger(t))}var Pe="https://logx.optimizely.com/v1/events";function Ce(r){var n=r.attributes,e=r.configObj,t=e.anonymizeIP,i=e.botFiltering;null==t&&(t=!1);var o={snapshots:[],visitor_id:r.userId,attributes:[]},s={account_id:e.accountId,project_id:e.projectId,visitors:[o],revision:e.revision,client_name:r.clientEngine,client_version:r.clientVersion,anonymize_ip:t,enrich_decisions:!0};return Object.keys(n||{}).forEach(function(e){var t;!Ve(e,n[e])||(t=C(r.configObj,e,r.logger))&&s.visitors[0].attributes.push({entity_id:t,key:e,type:"custom",value:n[e]})}),"boolean"==typeof i&&s.visitors[0].attributes.push({entity_id:d.BOT_FILTERING,key:d.BOT_FILTERING,type:"custom",value:i}),s}function Fe(e){return null!==(e=null===(e=e.experiment)||void 0===e?void 0:e.key)&&void 0!==e?e:""}function Me(e){return null!==(e=null===(e=e.variation)||void 0===e?void 0:e.key)&&void 0!==e?e:""}function xe(e){return null!==(e=null===(e=e.variation)||void 0===e?void 0:e.featureEnabled)&&void 0!==e&&e}var ke=a.getLogger("EVENT_BUILDER");function we(r,n){var i=[];return Object.keys(n||{}).forEach(function(e){var t;!Ve(e,n[e])||(t=C(r,e,ke))&&i.push({entityId:t,key:e,value:n[e]})}),i}var Be=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new(u.LogTierV1EventProcessor.bind.apply(u.LogTierV1EventProcessor,c([void 0],e)))},je=(u.LocalStoragePendingEventsDispatcher,"USER_PROFILE_SERVICE_VALIDATOR"),Ge=(Ye.prototype.isValidInstance=function(){return this.isOptimizelyConfigValid&&!!this.projectConfigManager.getConfig()},Ye.prototype.activate=function(e,t,r){try{if(!this.isValidInstance())return this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","activate")),null;if(!this.validateInputs({experiment_key:e,user_id:t},r))return this.notActivatingExperiment(e,t);var n=this.projectConfigManager.getConfig();if(!n)return null;try{var i=this.getVariation(e,t,r);if(null===i)return this.notActivatingExperiment(e,t);if("Running"!==L(n,e)){var o=g.sprintf(h.SHOULD_NOT_DISPATCH_ACTIVATE,"OPTIMIZELY",e);return this.logger.log(_.DEBUG,o),i}o=S(n,e),o={experiment:o,variation:o.variationKeyMap[i],decisionSource:I.EXPERIMENT};return this.sendImpressionEvent(o,"",t,!0,r),i}catch(r){this.logger.log(_.ERROR,r.message);var s=g.sprintf(h.NOT_ACTIVATING_USER,"OPTIMIZELY",t,e);return this.logger.log(_.INFO,s),this.errorHandler.handleError(r),null}}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.sendImpressionEvent=function(e,t,r,n,i){var o=this.projectConfigManager.getConfig();o&&(o=function(e){var t=e.configObj,r=e.decisionObj,n=e.userId,i=e.flagKey,o=e.enabled,s=e.userAttributes,a=e.clientEngine,u=e.clientVersion,l=r.decisionSource,c=Fe(r),f=Me(r),p=null,e=null;""!==c&&""!==f&&(e=H(t,c,f)),""!==c&&(p=Y(t,c));r=null;return null!==p&&(r=P(t,p)),{type:"impression",timestamp:G.currentTimestamp(),uuid:G.uuid(),user:{id:n,attributes:we(t,s)},context:{accountId:t.accountId,projectId:t.projectId,revision:t.revision,clientName:a,clientVersion:u,anonymizeIP:t.anonymizeIP||!1,botFiltering:t.botFiltering},layer:{id:r},experiment:{id:p,key:c},variation:{id:e,key:f},ruleKey:c,flagKey:i,ruleType:l,enabled:o}}({decisionObj:e,flagKey:t,enabled:n,userId:r,userAttributes:i,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:o}),this.eventProcessor.process(o),this.emitNotificationCenterActivate(e,t,r,n,i))},Ye.prototype.emitNotificationCenterActivate=function(e,t,r,n,i){var o,s,a,u,l,c=this.projectConfigManager.getConfig();c&&(o=e.decisionSource,l=Fe(e),s=Me(e),e=a=null,""!==l&&""!==s&&(e=b(c,l,s),a=U(c,l)),e=function(e){var t={httpVerb:"POST"},r=Ce(e);t.url=Pe;e=function(e,t,r,n,i,o,s){var a=null;null!==t&&(a=P(e,t));e=M(e,r);return null===e&&(e=""),{decisions:[{campaign_id:a,experiment_id:t,variation_id:r,metadata:{flag_key:o,rule_key:n,rule_type:i,variation_key:e,enabled:s}}],events:[{entity_id:a,timestamp:G.currentTimestamp(),key:"campaign_activated",uuid:G.uuid()}]}}(e.configObj,e.experimentId,e.variationId,e.ruleKey,e.ruleType,e.flagKey,e.enabled);return r.visitors[0].snapshots.push(e),t.params=r,t}({attributes:i,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:c,experimentId:a,ruleKey:l,flagKey:t,ruleType:o,userId:r,enabled:n,variationId:e,logger:this.logger}),(l=c.experimentKeyMap[l])&&l.variationKeyMap&&""!==s&&(u=l.variationKeyMap[s]),this.notificationCenter.sendNotifications(E.ACTIVATE,{experiment:l,userId:r,attributes:i,variation:u,logEvent:e}))},Ye.prototype.track=function(e,t,r,n){try{if(!this.isValidInstance())return void this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","track"));if(!this.validateInputs({user_id:t,event_key:e},r,n))return;var i=this.projectConfigManager.getConfig();if(!i)return;if(E=e,!i.eventKeyMap.hasOwnProperty(E))return this.logger.log(_.WARNING,g.sprintf(h.EVENT_KEY_NOT_FOUND,"OPTIMIZELY",e)),void this.logger.log(_.WARNING,g.sprintf(h.NOT_TRACKING_USER,"OPTIMIZELY",t));d=(s={eventKey:e,eventTags:n=this.filterEmptyValues(n),userId:t,userAttributes:r,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:i},a=s.configObj,u=s.userId,l=s.userAttributes,c=s.clientEngine,f=s.clientVersion,d=s.eventTags,E=F(a,p=s.eventKey),s=i=null,d&&(i=Se(d,ke),s=De(d,ke)),{type:"conversion",timestamp:G.currentTimestamp(),uuid:G.uuid(),user:{id:u,attributes:we(a,l)},context:{accountId:a.accountId,projectId:a.projectId,revision:a.revision,clientName:c,clientVersion:f,anonymizeIP:a.anonymizeIP||!1,botFiltering:a.botFiltering},event:{id:E,key:p},revenue:i,value:s,tags:d});this.logger.log(_.INFO,g.sprintf(h.TRACK_EVENT,"OPTIMIZELY",e,t)),this.eventProcessor.process(d),this.emitNotificationCenterTrack(e,t,r,n)}catch(e){this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e);var o=g.sprintf(h.NOT_TRACKING_USER,"OPTIMIZELY",t);this.logger.log(_.ERROR,o)}var s,a,u,l,c,f,p,d,E},Ye.prototype.emitNotificationCenterTrack=function(e,t,r,n){try{var i=this.projectConfigManager.getConfig();if(!i)return;i=function(e){var t={httpVerb:"POST"},r=Ce(e);t.url=Pe;var n,i,o,s,e=(n=e.configObj,i=e.eventKey,o=e.eventTags,s=e.logger,e={events:[]},n={entity_id:F(n,i),timestamp:G.currentTimestamp(),uuid:G.uuid(),key:i},o&&(null!==(i=Se(o,s))&&(n[p.REVENUE]=i),null!==(s=De(o,s))&&(n[p.VALUE]=s),n.tags=o),e.events.push(n),e);return r.visitors[0].snapshots=[e],t.params=r,t}({attributes:r,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:i,eventKey:e,eventTags:n,logger:this.logger,userId:t});this.notificationCenter.sendNotifications(E.TRACK,{eventKey:e,userId:t,attributes:r,eventTags:n,logEvent:i})}catch(e){this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e)}},Ye.prototype.getVariation=function(e,t,r){try{if(!this.isValidInstance())return this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","getVariation")),null;try{if(!this.validateInputs({experiment_key:e,user_id:t},r))return null;var n=this.projectConfigManager.getConfig();if(!n)return null;var i=n.experimentKeyMap[e];if(!i)return this.logger.log(_.DEBUG,g.sprintf(f.INVALID_EXPERIMENT_KEY,"OPTIMIZELY",e)),null;var o=this.decisionService.getVariation(n,e,t,r),i=V(n,i.id)?v.FEATURE_TEST:v.AB_TEST;return this.notificationCenter.sendNotifications(E.DECISION,{type:i,userId:t,attributes:r||{},decisionInfo:{experimentKey:e,variationKey:o}}),o}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.setForcedVariation=function(e,t,r){if(!this.validateInputs({experiment_key:e,user_id:t}))return!1;var n=this.projectConfigManager.getConfig();if(!n)return!1;try{return this.decisionService.setForcedVariation(n,e,t,r)}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),!1}},Ye.prototype.getForcedVariation=function(e,t){if(!this.validateInputs({experiment_key:e,user_id:t}))return null;var r=this.projectConfigManager.getConfig();if(!r)return null;try{return this.decisionService.getForcedVariation(r,e,t)}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.validateInputs=function(t,e,r){try{if(t.hasOwnProperty("user_id")){var n=t.user_id;if("string"!=typeof n||null===n||"undefined"===n)throw new Error(g.sprintf(f.INVALID_INPUT_FORMAT,"OPTIMIZELY","user_id"));delete t.user_id}return Object.keys(t).forEach(function(e){if(!ye(t[e]))throw new Error(g.sprintf(f.INVALID_INPUT_FORMAT,"OPTIMIZELY",e))}),e&&function(t){if("object"!=typeof t||Array.isArray(t)||null===t)throw new Error(g.sprintf(f.INVALID_ATTRIBUTES,"ATTRIBUTES_VALIDATOR"));Object.keys(t).forEach(function(e){if(void 0===t[e])throw new Error(g.sprintf(f.UNDEFINED_ATTRIBUTE,"ATTRIBUTES_VALIDATOR",e))})}(e),r&&function(e){if("object"!=typeof e||Array.isArray(e)||null===e)throw new Error(g.sprintf(f.INVALID_EVENT_TAGS,"EVENT_TAGS_VALIDATOR"))}(r),!0}catch(t){return this.logger.log(_.ERROR,t.message),this.errorHandler.handleError(t),!1}},Ye.prototype.notActivatingExperiment=function(e,t){e=g.sprintf(h.NOT_ACTIVATING_USER,"OPTIMIZELY",t,e);return this.logger.log(_.INFO,e),null},Ye.prototype.filterEmptyValues=function(e){for(var t in e)!e.hasOwnProperty(t)||null!==e[t]&&void 0!==e[t]||delete e[t];return e},Ye.prototype.isFeatureEnabled=function(e,t,r){try{if(!this.isValidInstance())return this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","isFeatureEnabled")),!1;if(!this.validateInputs({feature_key:e,user_id:t},r))return!1;var n=this.projectConfigManager.getConfig();if(!n)return!1;var i=D(n,e,this.logger);if(!i)return!1;var o={},s=this.decisionService.getVariationForFeature(n,i,t,r),a=s.decisionSource,u=Fe(s),l=Me(s),c=xe(s);a===I.FEATURE_TEST&&(o={experimentKey:u,variationKey:l}),(a===I.FEATURE_TEST||a===I.ROLLOUT&&n.sendFlagDecisions)&&this.sendImpressionEvent(s,i.key,t,c,r),!0===c?this.logger.log(_.INFO,g.sprintf(h.FEATURE_ENABLED_FOR_USER,"OPTIMIZELY",e,t)):(this.logger.log(_.INFO,g.sprintf(h.FEATURE_NOT_ENABLED_FOR_USER,"OPTIMIZELY",e,t)),c=!1);o={featureKey:e,featureEnabled:c,source:s.decisionSource,sourceInfo:o};return this.notificationCenter.sendNotifications(E.DECISION,{type:v.FEATURE,userId:t,attributes:r||{},decisionInfo:o}),c}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),!1}},Ye.prototype.getEnabledFeatures=function(t,r){var n=this;try{var i=[];if(!this.isValidInstance())return this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","getEnabledFeatures")),i;if(!this.validateInputs({user_id:t}))return i;var e=this.projectConfigManager.getConfig();return e&&g.objectValues(e.featureKeyMap).forEach(function(e){n.isFeatureEnabled(e.key,t,r)&&i.push(e.key)}),i}catch(t){return this.logger.log(_.ERROR,t.message),this.errorHandler.handleError(t),[]}},Ye.prototype.getFeatureVariable=function(e,t,r,n){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,null,r,n):(this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariable")),null)}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.getFeatureVariableForType=function(e,t,r,n,i){if(!this.validateInputs({feature_key:e,variable_key:t,user_id:n},i))return null;var o=this.projectConfigManager.getConfig();if(!o)return null;var s=D(o,e,this.logger);if(!s)return null;var a=function(e,t,r,n){e=e.featureKeyMap[t];return e?e.variableKeyMap[r]||(n.log(_.ERROR,g.sprintf(f.VARIABLE_KEY_NOT_IN_DATAFILE,K,r,t)),null):(n.log(_.ERROR,g.sprintf(f.FEATURE_NOT_IN_DATAFILE,K,t)),null)}(o,e,t,this.logger);if(!a)return null;if(r&&a.type!==r)return this.logger.log(_.WARNING,g.sprintf(h.VARIABLE_REQUESTED_WITH_WRONG_TYPE,"OPTIMIZELY",r,a.type)),null;var u=this.decisionService.getVariationForFeature(o,s,n,i),r=xe(u),o=this.getFeatureVariableValueFromVariation(e,r,u.variation,a,n),s={};return u.decisionSource===I.FEATURE_TEST&&null!==u.experiment&&null!==u.variation&&(s={experimentKey:u.experiment.key,variationKey:u.variation.key}),this.notificationCenter.sendNotifications(E.DECISION,{type:v.FEATURE_VARIABLE,userId:n,attributes:i||{},decisionInfo:{featureKey:e,featureEnabled:r,source:u.decisionSource,variableKey:t,variableValue:o,variableType:a.type,sourceInfo:s}}),o},Ye.prototype.getFeatureVariableValueFromVariation=function(e,t,r,n,i){var o=this.projectConfigManager.getConfig();if(!o)return null;var s=n.defaultValue;return null!==r?null!==(o=function(e,t,r,n){if(!t||!r)return null;if(!e.variationVariableUsageMap.hasOwnProperty(r.id))return n.log(_.ERROR,g.sprintf(f.VARIATION_ID_NOT_IN_DATAFILE_NO_EXPERIMENT,K,r.id)),null;t=e.variationVariableUsageMap[r.id][t.id];return t?t.value:null}(o,n,r,this.logger))?t?(s=o,this.logger.log(_.INFO,g.sprintf(h.USER_RECEIVED_VARIABLE_VALUE,"OPTIMIZELY",s,n.key,e))):this.logger.log(_.INFO,g.sprintf(h.FEATURE_NOT_ENABLED_RETURN_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",e,i,s)):this.logger.log(_.INFO,g.sprintf(h.VARIABLE_NOT_USED_RETURN_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",n.key,r.key)):this.logger.log(_.INFO,g.sprintf(h.USER_RECEIVED_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",i,n.key,e)),function(t,r,n){var i;switch(r){case y.BOOLEAN:i="true"!==t&&"false"!==t?(n.log(_.ERROR,g.sprintf(f.UNABLE_TO_CAST_VALUE,K,t,r)),null):"true"===t;break;case y.INTEGER:i=parseInt(t,10),isNaN(i)&&(n.log(_.ERROR,g.sprintf(f.UNABLE_TO_CAST_VALUE,K,t,r)),i=null);break;case y.DOUBLE:i=parseFloat(t),isNaN(i)&&(n.log(_.ERROR,g.sprintf(f.UNABLE_TO_CAST_VALUE,K,t,r)),i=null);break;case y.JSON:try{i=JSON.parse(t)}catch(e){n.log(_.ERROR,g.sprintf(f.UNABLE_TO_CAST_VALUE,K,t,r)),i=null}break;default:i=t}return i}(s,n.type,this.logger)},Ye.prototype.getFeatureVariableBoolean=function(e,t,r,n){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,y.BOOLEAN,r,n):(this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableBoolean")),null)}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.getFeatureVariableDouble=function(e,t,r,n){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,y.DOUBLE,r,n):(this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableDouble")),null)}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.getFeatureVariableInteger=function(e,t,r,n){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,y.INTEGER,r,n):(this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableInteger")),null)}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.getFeatureVariableString=function(e,t,r,n){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,y.STRING,r,n):(this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableString")),null)}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.getFeatureVariableJSON=function(e,t,r,n){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,y.JSON,r,n):(this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableJSON")),null)}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.getAllFeatureVariables=function(t,r,e){var n=this;try{if(!this.isValidInstance())return this.logger.log(_.ERROR,g.sprintf(h.INVALID_OBJECT,"OPTIMIZELY","getAllFeatureVariables")),null;if(!this.validateInputs({feature_key:t,user_id:r},e))return null;var i=this.projectConfigManager.getConfig();if(!i)return null;var o=D(i,t,this.logger);if(!o)return null;var s=this.decisionService.getVariationForFeature(i,o,r,e),a=xe(s),u={};o.variables.forEach(function(e){u[e.key]=n.getFeatureVariableValueFromVariation(t,a,s.variation,e,r)});o={};return s.decisionSource===I.FEATURE_TEST&&null!==s.experiment&&null!==s.variation&&(o={experimentKey:s.experiment.key,variationKey:s.variation.key}),this.notificationCenter.sendNotifications(E.DECISION,{type:v.ALL_FEATURE_VARIABLES,userId:r,attributes:e||{},decisionInfo:{featureKey:t,featureEnabled:a,source:s.decisionSource,variableValues:u,sourceInfo:o}}),u}catch(t){return this.logger.log(_.ERROR,t.message),this.errorHandler.handleError(t),null}},Ye.prototype.getOptimizelyConfig=function(){try{return this.projectConfigManager.getConfig()?this.projectConfigManager.getOptimizelyConfig():null}catch(e){return this.logger.log(_.ERROR,e.message),this.errorHandler.handleError(e),null}},Ye.prototype.close=function(){var t=this;try{var e=this.eventProcessor.stop();return this.disposeOnUpdate&&(this.disposeOnUpdate(),this.disposeOnUpdate=null),this.projectConfigManager&&this.projectConfigManager.stop(),Object.keys(this.readyTimeouts).forEach(function(e){e=t.readyTimeouts[e];clearTimeout(e.readyTimeout),e.onClose()}),this.readyTimeouts={},e.then(function(){return{success:!0}},function(e){return{success:!1,reason:String(e)}})}catch(t){return this.logger.log(_.ERROR,t.message),this.errorHandler.handleError(t),Promise.resolve({success:!1,reason:String(t)})}},Ye.prototype.onReady=function(e){var t,r,n=this;"object"==typeof e&&null!==e&&void 0!==e.timeout&&(t=e.timeout),G.isSafeInteger(t)||(t=3e4);var e=new Promise(function(e){r=e}),i=this.nextReadyTimeoutId;this.nextReadyTimeoutId++;var o=setTimeout(function(){delete n.readyTimeouts[i],r({success:!1,reason:g.sprintf("onReady timeout expired after %s ms",t)})},t);return this.readyTimeouts[i]={readyTimeout:o,onClose:function(){r({success:!1,reason:"Instance closed"})}},this.readyPromise.then(function(){clearTimeout(o),delete n.readyTimeouts[i],r({success:!0})}),Promise.race([this.readyPromise,e])},Ye),Ke=a.getLogger();function Ye(e){var t=this,r=e.clientEngine;-1===o.indexOf(r)&&(e.logger.log(_.INFO,g.sprintf(h.INVALID_CLIENT_ENGINE,"OPTIMIZELY",r)),r="node-sdk"),this.clientEngine=r,this.clientVersion=e.clientVersion||"4.4.3",this.errorHandler=e.errorHandler,this.eventDispatcher=e.eventDispatcher,this.isOptimizelyConfigValid=e.isValidInstance,this.logger=e.logger,this.projectConfigManager=new Z({datafile:e.datafile,datafileOptions:e.datafileOptions,jsonSchemaValidator:e.jsonSchemaValidator,sdkKey:e.sdkKey}),this.disposeOnUpdate=this.projectConfigManager.onUpdate(function(e){t.logger.log(_.INFO,g.sprintf(h.UPDATED_OPTIMIZELY_CONFIG,"OPTIMIZELY",e.revision,e.projectId)),t.notificationCenter.sendNotifications(E.OPTIMIZELY_CONFIG_UPDATE)});var n=this.projectConfigManager.onReady(),i=null;if(e.userProfileService)try{!function(e){if("object"!=typeof e||null===e)throw new Error(g.sprintf(f.INVALID_USER_PROFILE_SERVICE,je));if("function"!=typeof e.lookup)throw new Error(g.sprintf(f.INVALID_USER_PROFILE_SERVICE,je,"Missing function 'lookup'"));if("function"!=typeof e.save)throw new Error(g.sprintf(f.INVALID_USER_PROFILE_SERVICE,je,"Missing function 'save'"));return 1}(e.userProfileService)||(i=e.userProfileService,this.logger.log(_.INFO,g.sprintf(h.VALID_USER_PROFILE_SERVICE,"OPTIMIZELY")))}catch(e){this.logger.log(_.WARNING,e.message)}this.decisionService=new Ue({userProfileService:i,logger:this.logger,UNSTABLE_conditionEvaluators:e.UNSTABLE_conditionEvaluators}),this.notificationCenter=(r={logger:this.logger,errorHandler:this.errorHandler},new $(r));r={dispatcher:this.eventDispatcher,flushInterval:e.eventFlushInterval,batchSize:e.eventBatchSize,maxQueueSize:e.eventMaxQueueSize,notificationCenter:this.notificationCenter};this.eventProcessor=Be(r);r=this.eventProcessor.start();this.readyPromise=Promise.all([n,r]).then(function(e){return e[0]}),this.readyTimeouts={},this.nextReadyTimeoutId=0}a.setLogHandler(B.createLogger()),a.setLogLevel(a.LogLevel.INFO);var He=!1,ze=function(t){try{t.errorHandler&&a.setErrorHandler(t.errorHandler),t.logger&&(a.setLogHandler(t.logger),a.setLogLevel(a.LogLevel.NOTSET)),void 0!==t.logLevel&&a.setLogLevel(t.logLevel);try{(function(e){if("object"!=typeof e||null===e)throw new Error(g.sprintf(f.INVALID_CONFIG,R));var t=e.errorHandler,r=e.eventDispatcher,e=e.logger;if(t&&"function"!=typeof t.handleError)throw new Error(g.sprintf(f.INVALID_ERROR_HANDLER,R));if(r&&"function"!=typeof r.dispatchEvent)throw new Error(g.sprintf(f.INVALID_EVENT_DISPATCHER,R));if(e&&"function"!=typeof e.log)throw new Error(g.sprintf(f.INVALID_LOGGER,R))})(t),t.isValidInstance=!0}catch(e){Ke.error(e),t.isValidInstance=!1}var e=void 0;null==t.eventDispatcher?(e=new u.LocalStoragePendingEventsDispatcher({eventDispatcher:m}),He||(e.sendPendingEvents(),He=!0)):e=t.eventDispatcher;var r=t.eventBatchSize,n=t.eventFlushInterval;!("number"!=typeof(s=t.eventBatchSize)||!G.isSafeInteger(s))&&1<=s||(Ke.warn("Invalid eventBatchSize %s, defaulting to %s",t.eventBatchSize,10),r=10),!("number"!=typeof(s=t.eventFlushInterval)||!G.isSafeInteger(s))&&0<s||(Ke.warn("Invalid eventFlushInterval %s, defaulting to %s",t.eventFlushInterval,1e3),n=1e3);var i,n=l(l({clientEngine:"javascript-sdk",eventDispatcher:e},t),{eventBatchSize:r,eventFlushInterval:n,logger:Ke,errorHandler:a.getErrorHandler()}),o=new Ge(n);try{"function"==typeof window.addEventListener&&(i="onpagehide"in window?"pagehide":"unload",window.addEventListener(i,function(){o.close()},!1))}catch(t){Ke.error(h.UNABLE_TO_ATTACH_UNLOAD,"INDEX_BROWSER",t.message)}return o}catch(t){return Ke.error(t),null}var s},s=function(){He=!1},i={logging:B,errorHandler:N,eventDispatcher:m,enums:O,setLogger:a.setLogHandler,setLogLevel:a.setLogLevel,createInstance:ze,__internalResetRetryState:s};Object.defineProperty(t,"setLogLevel",{enumerable:!0,get:function(){return a.setLogLevel}}),Object.defineProperty(t,"setLogger",{enumerable:!0,get:function(){return a.setLogHandler}}),t.__internalResetRetryState=s,t.createInstance=ze,t.default=i,t.enums=O,t.errorHandler=N,t.eventDispatcher=m,t.logging=B}),Pe=Xe.getLogger("ReactSDK");function Ce(e,t){return e.entityKey===t.entityKey&&e.overrideUserId===t.overrideUserId&&le(e.overrideAttributes,t.overrideAttributes)}function Fe(e,t,r){e.onReady({timeout:t}).then(function(e){return e.success?(Pe.info("Client became ready"),void r({clientReady:!0,didTimeout:!1})):(Pe.info("Client did not become ready before timeout of "+t+'ms, reason="'+(e.reason||"")+'"'),r({clientReady:!1,didTimeout:!0}),void e.dataReadyPromise.then(function(){Pe.info("Client became ready after timeout already elapsed"),r({clientReady:!0,didTimeout:!0})}))}).catch(function(){Pe.error("Error initializing client. The core client or user promise(s) rejected.")})}function Me(e){var t=E.useRef();return le(e,t.current)||(t.current=e),t.current}(u=ge=ge||{}).EXPERIMENT="Experiment",u.FEATURE="Feature";function xe(e,t,r){void 0===t&&(t={}),void 0===r&&(r={});var n=(f=E.useContext(g)).optimizely,i=f.isServerSide,o=f.timeout;if(!n)throw new Error("optimizely prop must be supplied via a parent <OptimizelyProvider>");var s=Me(r.overrideAttributes),a=E.useCallback(function(){return{variation:n.activate(e,r.overrideUserId,s)}},[n,e,r.overrideUserId,s]),u=i||n.isReady(),l=(p=E.useState(function(){var e=u?a():{variation:null};return _({},e,{clientReady:u,didTimeout:!1})}))[0],c=p[1],f={entityKey:e,overrideUserId:r.overrideUserId,overrideAttributes:s},p=(i=E.useState(f))[0],i=i[1];Ce(p,f)||(i(f),c(function(e){return _({},e,a())}));var d=void 0!==t.timeout?t.timeout:o;return E.useEffect(function(){u||Fe(n,d,function(e){c(_({},a(),e))})},[u,d,c,a,n]),E.useEffect(function(){return t.autoUpdate?Ee(n,ge.EXPERIMENT,e,Pe,function(){c(function(e){return _({},e,a())})}):function(){}},[u,t.autoUpdate,n,e,c,a]),[l.variation,l.clientReady,l.didTimeout]}function ke(e,t,r){void 0===t&&(t={}),void 0===r&&(r={});var n=(f=E.useContext(g)).optimizely,i=f.isServerSide,o=f.timeout;if(!n)throw new Error("optimizely prop must be supplied via a parent <OptimizelyProvider>");var s=Me(r.overrideAttributes),a=E.useCallback(function(){return{isEnabled:n.isFeatureEnabled(e,r.overrideUserId,s),variables:n.getFeatureVariables(e,r.overrideUserId,s)}},[n,e,r.overrideUserId,s]),u=i||n.isReady(),l=(p=E.useState(function(){var e=u?a():{isEnabled:!1,variables:{}};return _({},e,{clientReady:u,didTimeout:!1})}))[0],c=p[1],f={entityKey:e,overrideUserId:r.overrideUserId,overrideAttributes:r.overrideAttributes},p=(i=E.useState(f))[0],i=i[1];Ce(p,f)||(i(f),c(function(e){return _({},e,a())}));var d=void 0!==t.timeout?t.timeout:o;return E.useEffect(function(){u||Fe(n,d,function(e){c(_({},a(),e))})},[u,d,c,a,n]),E.useEffect(function(){return t.autoUpdate?Ee(n,ge.FEATURE,e,Pe,function(){c(function(e){return _({},e,a())})}):function(){}},[u,t.autoUpdate,n,e,c,a]),[l.isEnabled,l.variables,l.clientReady,l.didTimeout]}l=function(e){var t=e.feature,r=e.timeout,n=e.autoUpdate,i=e.children,o=e.overrideUserId,e=e.overrideAttributes,r=ke(t,{timeout:r,autoUpdate:n},{overrideUserId:o,overrideAttributes:e}),n=r[0],o=r[1],e=r[2],r=r[3];return e||r?E.createElement(E.Fragment,null,i(n,o,e,r)):null};var R=function(e){var t=e.experiment,r=e.autoUpdate,n=e.timeout,i=e.overrideUserId,o=e.overrideAttributes,e=e.children,i=xe(t,{timeout:n,autoUpdate:r},{overrideUserId:i,overrideAttributes:o}),s=i[0],o=i[1],i=i[2];if(!o&&!i)return null;if(null!=e&&"function"==typeof e)return E.createElement(E.Fragment,null,e(s,o,i));var a=null;return E.Children.forEach(e,function(e){!a&&E.isValidElement(e)&&(e.props.variation?s===e.props.variation&&(a=e):e.props.default&&(a=e))}),a?E.cloneElement(a,{variation:s}):null},A=function(e){e=e.children;return E.createElement(E.Fragment,null,e)},we=Xe.getLogger("ReactSDK"),Be=(je.prototype.onReady=function(e){var t,r=this;void 0===e&&(e={});var n=5e3;e&&void 0!==e.timeout&&(n=e.timeout);e=new Promise(function(e){t=setTimeout(function(){e({success:!1,reason:"failed to initialize onReady before timeout, either the datafile or user info was not set before the timeout",dataReadyPromise:r.dataReadyPromise})},n)});return Promise.race([this.dataReadyPromise,e]).then(function(e){return clearTimeout(t),e})},je.prototype.setUser=function(e){var t=this;e.id&&(this.user.id=e.id),e.attributes&&(this.user.attributes=e.attributes),this.isUserPromiseResolved||(this.userPromiseResovler(this.user),this.isUserPromiseResolved=!0),this.onUserUpdateHandlers.forEach(function(e){return e(t.user)})},je.prototype.onUserUpdate=function(t){var r=this;return this.onUserUpdateHandlers.push(t),function(){var e=r.onUserUpdateHandlers.indexOf(t);-1<e&&r.onUserUpdateHandlers.splice(e,1)}},je.prototype.isReady=function(){return this.dataReadyPromiseFulfilled},je.prototype.activate=function(e,t,r){r=this.getUserContextWithOverrides(t,r);return null===r.id?(we.info('Not activating experiment "%s" because userId is not set',e),null):this._client.activate(e,r.id,r.attributes)},je.prototype.getVariation=function(e,t,r){r=this.getUserContextWithOverrides(t,r);return null===r.id?(we.info('getVariation returned null for experiment "%s" because userId is not set',e),null):this._client.getVariation(e,r.id,r.attributes)},je.prototype.track=function(e,t,r,n){void 0!==t&&"string"!=typeof t&&(n=t,r=t=void 0);r=this.getUserContextWithOverrides(t,r);if(null!==r.id)return this._client.track(e,r.id,r.attributes,n);we.info('track for event "%s" not being sent because userId is not set',e)},je.prototype.isFeatureEnabled=function(e,t,r){r=this.getUserContextWithOverrides(t,r);return null===r.id?(we.info('isFeatureEnabled returning false for feature "%s" because userId is not set',e),!1):this._client.isFeatureEnabled(e,r.id,r.attributes)},je.prototype.getFeatureVariables=function(t,e,r){var n=this,r=this.getUserContextWithOverrides(e,r),i=r.id;if(null===i)return we.info('getFeatureVariables returning `{}` for feature "%s" because userId is not set',t),{};var o=r.attributes,s={},r=this._client.getOptimizelyConfig();if(!r)return{};var a=r.featuresMap[t];return a?(Object.keys(a.variablesMap).forEach(function(e){e=a.variablesMap[e];s[e.key]=n._client.getFeatureVariable(t,e.key,i,o)}),s):{}},je.prototype.getFeatureVariableString=function(e,t,r,n){n=this.getUserContextWithOverrides(r,n);return null===n.id?null:this._client.getFeatureVariableString(e,t,n.id,n.attributes)},je.prototype.getFeatureVariableBoolean=function(e,t,r,n){n=this.getUserContextWithOverrides(r,n);return null===n.id?null:this._client.getFeatureVariableBoolean(e,t,n.id,n.attributes)},je.prototype.getFeatureVariableInteger=function(e,t,r,n){n=this.getUserContextWithOverrides(r,n);return null===n.id?null:this._client.getFeatureVariableInteger(e,t,n.id,n.attributes)},je.prototype.getFeatureVariableDouble=function(e,t,r,n){n=this.getUserContextWithOverrides(r,n);return null===n.id?null:this._client.getFeatureVariableDouble(e,t,n.id,n.attributes)},je.prototype.getFeatureVariableJSON=function(e,t,r,n){n=this.getUserContextWithOverrides(r,n);return null===n.id?null:this._client.getFeatureVariableJSON(e,t,n.id,n.attributes)},je.prototype.getFeatureVariable=function(e,t,r,n){n=this.getUserContextWithOverrides(r,n);return null===n.id?null:this._client.getFeatureVariable(e,t,n.id,n.attributes)},je.prototype.getAllFeatureVariables=function(e,t,r){r=this.getUserContextWithOverrides(t,r);return null===r.id?{}:this._client.getAllFeatureVariables(e,r.id,r.attributes)},je.prototype.getEnabledFeatures=function(e,t){t=this.getUserContextWithOverrides(e,t);return null===t.id?[]:this._client.getEnabledFeatures(t.id,t.attributes)},je.prototype.getForcedVariation=function(e,t){t=this.getUserContextWithOverrides(t);return null===t.id?null:this._client.getForcedVariation(e,t.id)},je.prototype.setForcedVariation=function(e,t,r){var n=null,i=null;if(2===arguments.length)i=t,n=this.getUserContextWithOverrides().id;else if(3===arguments.length){if(n=this.getUserContextWithOverrides(t).id,void 0===r)return!1;i=r}return null!==n&&this._client.setForcedVariation(e,n,i)},je.prototype.getOptimizelyConfig=function(){return this._client.getOptimizelyConfig()},je.prototype.close=function(){return this._client.close()},Object.defineProperty(je.prototype,"client",{get:function(){return this._client},enumerable:!0,configurable:!0}),Object.defineProperty(je.prototype,"notificationCenter",{get:function(){return this._client.notificationCenter},enumerable:!0,configurable:!0}),je.prototype.getUserContextWithOverrides=function(e,t){return{id:void 0===e?this.user.id:e,attributes:void 0===t?this.user.attributes:t}},je);function je(e){var t=this;this.user={id:null,attributes:{}},this.isUserPromiseResolved=!1,this.onUserUpdateHandlers=[],this.dataReadyPromiseFulfilled=!1,this.initialConfig=e,this.userPromiseResovler=function(){};e=_({},e,{clientEngine:"react-sdk",clientVersion:"2.4.0"});this._client=Ve.createInstance(e),this.userPromise=new Promise(function(e){t.userPromiseResovler=e}).then(function(){return{success:!0}}),this.dataReadyPromise=Promise.all([this.userPromise,this._client.onReady()]).then(function(){return{success:t.dataReadyPromiseFulfilled=!0,reason:"datafile and user resolved"}})}var Ge=Xe.getLogger("ReactSDK"),u={dispatchEvent:function(e,t){Ge.debug("Event not dispatched by disabled event dispatcher: %s",function(){var t;try{t=JSON.stringify(e)}catch(e){t="error stringifying event"}return t}),t({statusCode:204})}};e.OptimizelyContext=g,e.OptimizelyContextConsumer=i,e.OptimizelyContextProvider=n,e.OptimizelyExperiment=R,e.OptimizelyFeature=l,e.OptimizelyProvider=pe,e.OptimizelyVariation=A,e.createInstance=function(e){return new Be(e)},e.enums=Ve.enums,e.errorHandler=Ve.errorHandler,e.eventDispatcher=Ve.eventDispatcher,e.logOnlyEventDispatcher=u,e.logging=Ve.logging,e.setLogLevel=Ve.setLogLevel,e.setLogger=Ve.setLogger,e.useExperiment=xe,e.useFeature=ke,e.withOptimizely=function(n){var e;function t(){return null!==e&&e.apply(this,arguments)||this}return ae((r(t,e=E.Component),t.prototype.render=function(){var e=this.props,t=e.forwardedRef,r=function(e,t){var r={};for(i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(r[i[n]]=e[i[n]]);return r}(e,["forwardedRef"]);return E.createElement(i,null,function(e){return E.createElement(n,_({},r,{optimizelyReadyTimeout:e.timeout,optimizely:e.optimizely,isServerSide:e.isServerSide,ref:t}))})},t),n,"withOptimizely")},Object.defineProperty(e,"__esModule",{value:!0})});
